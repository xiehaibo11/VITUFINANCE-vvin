import{r as e,c as a,_ as l,x as o,V as s,A as t,o as r,B as n,D as u,E as i,O as d,m as c,K as m,C as p,Y as v,ay as g,aX as f,ap as h,M as b}from"./vue-vendor-CCmsYA1Y.js";import{l as y,v as _}from"./index-DcuAk0vn.js";import{B as k}from"./Background3D-1KBsd1Mq.js";import{_ as w}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{b as x}from"./element-plus-BZcENYie.js";import"./vendor-BQF3adi-.js";import"./index-BxKU4Ero.js";import"./three-zurYmXlw.js";const V={class:"login-container"},S={class:"login-header"},C={class:"title"},M={class:"subtitle"},I={class:"card-content"},j={class:"input-group"},T={class:"input-group"},A={class:"captcha-container"},q={class:"input-group",style:{flex:"1"}},B={class:"form-footer"},L={key:0},R={key:1},U={class:"form-options"},E={class:"input-group"},F={class:"form-footer"},K={key:0},P={key:1},z={class:"form-options"},D=w({__name:"Login",setup(w){const D=f(),O=e("login"),X=e(""),Y=e(null),G=e(0),W=e(0),$=e(!1),H=e=>{if(!Y.value)return;const a=Y.value.getBoundingClientRect();G.value=e.clientX-a.left,W.value=e.clientY-a.top,$.value=!0},J=()=>{$.value=!1},N=a(()=>({"--mouse-x":`${G.value}px`,"--mouse-y":`${W.value}px`,opacity:$.value?1:0})),Q=e(null),Z=e(null),ee=e(!1),ae=l({username:"",password:"",captcha:"",remember:!1}),le=l({code:""}),oe=e(null),se=e(""),te=()=>{const e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let a="";for(let l=0;l<4;l++)a+=e[Math.floor(62*Math.random())];se.value=a,setTimeout(()=>re(a),0)},re=e=>{const a=oe.value;if(!a)return;const l=a.getContext("2d"),o=a.width,s=a.height;l.clearRect(0,0,o,s),l.font="bold 24px Arial",l.textBaseline="middle",l.textAlign="center";for(let t=0;t<e.length;t++){const a=o/5*(t+1),r=s/2,n=30*(Math.random()-.5)*Math.PI/180;l.save(),l.translate(a,r),l.rotate(n),l.fillStyle="#f0f6fc",l.fillText(e[t],0,0),l.restore()}for(let t=0;t<3;t++)l.beginPath(),l.moveTo(Math.random()*o,Math.random()*s),l.lineTo(Math.random()*o,Math.random()*s),l.strokeStyle="rgba(255, 255, 255, 0.2)",l.stroke()},ne={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度在 3 到 20 个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,max:30,message:"密码长度在 6 到 30 个字符",trigger:"blur"}],captcha:[{required:!0,message:"请输入验证码",trigger:"blur"},{validator:(e,a,l)=>{a.toLowerCase()!==se.value.toLowerCase()?l(new Error("验证码错误")):l()},trigger:"blur"}]},ue={code:[{required:!0,message:"请输入验证码",trigger:"blur"},{len:6,message:"验证码为6位数字",trigger:"blur"}]},ie=async()=>{var e,a;if(await Q.value.validate().catch(()=>!1)){ee.value=!0;try{const e=await y({username:ae.username,password:ae.password});e.success&&e.require2FA?(X.value=e.tempToken,O.value="2fa",x.info("请输入双因素验证码")):e.success?(localStorage.setItem("admin_token",e.data.token),ae.remember?localStorage.setItem("admin_username",ae.username):localStorage.removeItem("admin_username"),x.success("登录成功"),D.push("/dashboard")):(x.error(e.message||"登录失败"),te())}catch(l){const o=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"登录失败，请稍后重试";x.error(o),te()}finally{ee.value=!1}}},de=async()=>{var e,a;if(await Z.value.validate().catch(()=>!1)){ee.value=!0;try{const e=await _({tempToken:X.value,totpCode:le.code});e.success?(localStorage.setItem("admin_token",e.data.token),ae.remember?localStorage.setItem("admin_username",ae.username):localStorage.removeItem("admin_username"),x.success("登录成功"),D.push("/dashboard")):(x.error(e.message||"验证码错误"),le.code="")}catch(l){const o=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"验证失败";x.error(o),le.code=""}finally{ee.value=!1}}};let ce=null;return o(()=>{ce=localStorage.getItem("admin_theme"),document.documentElement.classList.add("dark");const e=localStorage.getItem("admin_username");e&&(ae.username=e,ae.remember=!0),te()}),s(()=>{"light"===ce&&document.documentElement.classList.remove("dark")}),(e,a)=>{const l=g("el-input"),o=g("el-form-item"),s=g("el-button"),f=g("el-checkbox"),y=g("el-form");return r(),t("div",V,[n(k),u("div",{class:"login-card",onMousemove:H,onMouseleave:J,ref_key:"cardRef",ref:Y},[u("div",{class:"glow-effect",style:i(N.value)},null,4),u("div",S,[u("h1",C,d("2fa"===O.value?"双因素验证":"Welcome back"),1),u("p",M,d("2fa"===O.value?"请输入 Authenticator 验证码":"登录 VituFinance 管理系统"),1)]),u("div",I,["login"===O.value?(r(),c(y,{key:0,ref_key:"loginFormRef",ref:Q,model:ae,rules:ne,class:"login-form",onSubmit:v(ie,["prevent"])},{default:p(()=>[n(o,{prop:"username"},{default:p(()=>[a[6]||(a[6]=u("div",{class:"input-label"},"账号",-1)),u("div",j,[n(l,{modelValue:ae.username,"onUpdate:modelValue":a[0]||(a[0]=e=>ae.username=e),placeholder:"请输入用户名",class:"login-input"},null,8,["modelValue"])])]),_:1}),n(o,{prop:"password"},{default:p(()=>[a[7]||(a[7]=u("div",{class:"input-label"},"密码",-1)),u("div",T,[n(l,{modelValue:ae.password,"onUpdate:modelValue":a[1]||(a[1]=e=>ae.password=e),type:"password",placeholder:"请输入密码","show-password":"",class:"login-input"},null,8,["modelValue"])])]),_:1}),n(o,{prop:"captcha"},{default:p(()=>[a[8]||(a[8]=u("div",{class:"input-label"},"验证码",-1)),u("div",A,[u("div",q,[n(l,{modelValue:ae.captcha,"onUpdate:modelValue":a[2]||(a[2]=e=>ae.captcha=e),placeholder:"输入验证码",class:"login-input",onKeyup:h(ie,["enter"])},null,8,["modelValue"])]),u("div",{class:"captcha-wrapper",onClick:te,title:"点击刷新"},[u("canvas",{ref_key:"captchaCanvas",ref:oe,width:"100",height:"40"},null,512)])])]),_:1}),u("div",B,[n(s,{type:"primary",loading:ee.value,class:"login-btn",onClick:ie},{default:p(()=>[ee.value?(r(),t("span",R,"验证中...")):(r(),t("span",L,"登 录"))]),_:1},8,["loading"])]),u("div",U,[n(f,{modelValue:ae.remember,"onUpdate:modelValue":a[3]||(a[3]=e=>ae.remember=e)},{default:p(()=>[...a[9]||(a[9]=[b("记住我",-1)])]),_:1},8,["modelValue"])])]),_:1},8,["model"])):m("",!0),"2fa"===O.value?(r(),c(y,{key:1,ref_key:"tfaFormRef",ref:Z,model:le,rules:ue,class:"login-form",onSubmit:v(de,["prevent"])},{default:p(()=>[a[12]||(a[12]=u("div",{class:"tfa-hint"},[u("p",null,"打开 Google Authenticator 或其他 TOTP 应用，输入 6 位动态验证码")],-1)),n(o,{prop:"code"},{default:p(()=>[a[10]||(a[10]=u("div",{class:"input-label"},"动态验证码",-1)),u("div",E,[n(l,{modelValue:le.code,"onUpdate:modelValue":a[4]||(a[4]=e=>le.code=e),placeholder:"000000",class:"login-input tfa-input",maxlength:"6",onKeyup:h(de,["enter"]),autofocus:""},null,8,["modelValue"])])]),_:1}),u("div",F,[n(s,{type:"primary",loading:ee.value,class:"login-btn",onClick:de},{default:p(()=>[ee.value?(r(),t("span",P,"验证中...")):(r(),t("span",K,"验 证"))]),_:1},8,["loading"])]),u("div",z,[n(s,{link:"",onClick:a[5]||(a[5]=e=>O.value="login"),style:{color:"#8b949e","font-size":"12px"}},{default:p(()=>[...a[11]||(a[11]=[b(" ← 返回登录 ",-1)])]),_:1})])]),_:1},8,["model"])):m("",!0)])],544),a[13]||(a[13]=u("div",{class:"version-info"},[u("span",null,"v1.0.0")],-1))])}}},[["__scopeId","data-v-53870f3b"]]);export{D as default};
