# 钱包扣费功能说明

## 功能概述

管理后台新增"钱包扣费"功能，允许管理员直接从用户授权的钱包中扣除 USDT。

## 工作原理

1. **用户授权**：用户需要先在钱包中授权平台地址可以使用其 USDT
2. **管理员扣费**：管理员在后台点击"扣费"按钮，填写扣费金额和原因
3. **链上转账**：系统使用 `transferFrom` 方法，从用户钱包转账到平台钱包
4. **记录日志**：扣费成功后，记录到 `wallet_deduction_logs` 表

## 使用步骤

### 1. 用户授权（前提条件）

用户需要在钱包中授权平台地址：

**平台地址**：
- **BSC**：`0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4`
- **ETH**：`0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d`
- **TRON**：`TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi`

**授权方法**：
- 方式一：用户在 DApp 中进行充值操作时，会自动请求授权
- 方式二：用户手动在区块链浏览器上授权
  - BSC: https://bscscan.com
  - ETH: https://etherscan.io
  - TRON: https://tronscan.org
- 方式三：用户在钱包（如 imToken）的授权管理中添加授权

### 2. 管理员扣费操作

1. 登录管理后台
2. 进入"用户管理"页面
3. 找到目标用户，点击"扣费"按钮
4. 填写扣费信息：
   - **扣费金额**：输入要扣除的 USDT 数量（0.01-10000）
   - **扣费链**：选择 BSC、ETH 或 TRON（目前仅支持 BSC 和 ETH）
   - **扣费原因**：必填，说明扣费原因（如：订阅费用、服务费、违规罚款等）
   - **操作员备注**：可选，内部备注信息
5. 点击"确认扣费"
6. 二次确认后，系统执行扣费
7. 扣费成功后，显示交易哈希

### 3. 查看扣费记录

扣费记录保存在 `wallet_deduction_logs` 表中，包含：
- 用户钱包地址
- 扣费金额
- 扣费链
- 交易哈希
- 扣费原因
- 管理员备注
- 创建时间

## 支持的链

| 链 | 状态 | USDT 合约地址 | 小数位数 | 平台地址 |
|----|------|--------------|---------|---------|
| BSC | ✅ 支持 | 0x55d398326f99059fF775485246999027B3197955 | 18 | 0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4 |
| ETH | ✅ 支持 | 0xdAC17F958D2ee523a2206206994597C13D831ec7 | 6 | 0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d |
| TRON | ✅ 支持 | TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t | 6 | TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi |

## 前提条件

### 1. 用户必须已授权

用户需要在钱包中授权平台地址可以使用其 USDT。可以通过以下 API 检查授权状态：

```bash
GET /api/admin/users/check-allowance?wallet_address=0x...&chain=BSC
```

返回示例：
```json
{
  "success": true,
  "data": {
    "allowance": "1000.0000",  // 授权额度
    "balance": "500.0000",     // 用户余额
    "platform_address": "0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4",
    "chain": "BSC"
  }
}
```

### 2. 用户钱包有足够余额

用户钱包中必须有足够的 USDT 余额来支付扣费金额。

### 3. 平台钱包有足够 Gas 费

平台钱包需要有足够的原生代币来支付 Gas 费：
- **BSC**：需要 BNB（建议至少 0.1 BNB）
- **ETH**：需要 ETH（建议至少 0.01 ETH）
- **TRON**：需要 TRX（建议至少 30 TRX）用于支付能量费

## 错误处理

### 常见错误

1. **授权额度不足**
   - 错误信息：`用户授权额度不足。当前授权：X USDT，需要：Y USDT`
   - 解决方法：用户需要增加授权额度

2. **用户余额不足**
   - 错误信息：`用户钱包余额不足。当前余额：X USDT`
   - 解决方法：用户需要充值

3. **平台 Gas 费不足**
   - 错误信息：`平台钱包 Gas 费不足`
   - 解决方法：给平台钱包充值 BNB 或 ETH

4. **交易被拒绝**
   - 错误信息：`交易被拒绝，可能是授权额度不足或用户余额不足`
   - 解决方法：检查授权和余额

## 安全注意事项

1. **谨慎操作**：扣费操作不可撤销，请仔细核对信息
2. **记录原因**：必须填写扣费原因，便于后续审计
3. **二次确认**：系统会要求二次确认，防止误操作
4. **日志记录**：所有扣费操作都会记录到数据库
5. **权限控制**：只有管理员可以执行扣费操作

## 技术实现

### 后端 API

**扣费接口**：
```
POST /api/admin/users/deduct-from-wallet
```

**请求参数**：
```json
{
  "wallet_address": "0x...",
  "amount": 100,
  "chain": "BSC",
  "reason": "订阅费用",
  "admin_remark": "2024年1月订阅"
}
```

**返回示例**：
```json
{
  "success": true,
  "message": "扣费成功",
  "data": {
    "txHash": "0x...",
    "blockNumber": 12345678,
    "amount": 100,
    "chain": "BSC",
    "from": "0x...",
    "to": "0x..."
  }
}
```

### 智能合约方法

使用 ERC20 标准的 `transferFrom` 方法：

```solidity
function transferFrom(address from, address to, uint256 amount) returns (bool)
```

### 数据库表结构

```sql
CREATE TABLE `wallet_deduction_logs` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `wallet_address` VARCHAR(255) NOT NULL,
  `amount` DECIMAL(20, 4) NOT NULL,
  `chain` VARCHAR(20) NOT NULL,
  `tx_hash` VARCHAR(255) NOT NULL,
  `reason` TEXT NOT NULL,
  `admin_remark` TEXT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_wallet_address` (`wallet_address`),
  INDEX `idx_chain` (`chain`),
  INDEX `idx_created_at` (`created_at`)
);
```

### 配置要求

### 环境变量

需要在 `.env` 文件中配置：

```env
# EVM 链转账私钥（BSC/ETH）
TRANSFER_PRIVATE_KEY=your_evm_private_key_here

# TRON 链转账私钥
TRON_PRIVATE_KEY=your_tron_private_key_here

# RPC URLs
BSC_RPC_URL=https://bsc-dataseed.binance.org
ETH_RPC_URL=https://eth.llamarpc.com
TRON_RPC_URL=https://api.trongrid.io

# Gas 价格（可选）
GAS_PRICE=5  # Gwei
```

**注意**：
- 如果没有配置 `TRON_PRIVATE_KEY`，系统会使用 `TRANSFER_PRIVATE_KEY`
- TRON 私钥格式与 EVM 链不同，请确保使用正确的私钥

## 常见问题

### Q1: 用户如何授权？

A: 用户可以通过以下方式授权：
1. 在 DApp 中进行充值操作时自动授权
2. 在区块链浏览器（BSCScan/Etherscan）上手动授权
3. 在钱包（imToken/MetaMask）的授权管理中添加

### Q2: 授权是一次性的吗？

A: 不是。用户可以授权一个额度（如 1000 USDT），平台可以在这个额度内多次扣费，直到额度用完。

### Q3: 如何查看用户的授权状态？

A: 使用 API：
- BSC: `GET /api/admin/users/check-allowance?wallet_address=0x...&chain=BSC`
- ETH: `GET /api/admin/users/check-allowance?wallet_address=0x...&chain=ETH`
- TRON: `GET /api/admin/users/check-allowance?wallet_address=T...&chain=TRON`

### Q4: 扣费失败怎么办？

A: 检查以下几点：
1. 用户是否已授权
2. 用户钱包余额是否足够
3. 平台钱包 Gas 费是否足够
4. 网络是否正常

### Q5: 可以撤销扣费吗？

A: 不可以。扣费是链上交易，一旦确认就无法撤销。如需退款，需要另外转账给用户。

### Q6: TRON 链什么时候支持？

A: ✅ TRON 链已经支持！用户需要在 TRON 钱包中授权平台地址 `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi`。

### Q7: TRON 链扣费需要注意什么？

A: 
1. 平台钱包需要有足够的 TRX（建议至少 30 TRX）来支付能量费
2. TRON 地址格式以 T 开头，与 EVM 地址（0x 开头）不同
3. TRON 交易确认通常很快（3秒左右）
4. 可以在 https://tronscan.org 查看交易详情

## 更新日志

### 2026-02-28
- ✅ 添加钱包扣费功能
- ✅ 支持 BSC、ETH 和 TRON 三条链
- ✅ 添加扣费日志记录
- ✅ 添加授权额度查询 API
- ✅ TRON 链完整支持（使用 TronWeb）
- ✅ 支持多链平台地址管理

---

**重要提示**：此功能涉及资金操作，请谨慎使用！
