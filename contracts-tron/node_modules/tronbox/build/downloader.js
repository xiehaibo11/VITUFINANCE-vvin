"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var chalk=require("chalk");var path=require("path");var fs=require("fs-extra");var homedir=require("homedir");var req=require("axios");function downloader(_x,_x2){return _downloader.apply(this,arguments)}function _downloader(){_downloader=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(compilerVersion,evm){var dir,soljsonPath,soljsonUrl,solidityUrl,list,_solidityUrl,_list,res,_t,_t2,_t3;return _regenerator["default"].wrap(function(_context){while(1)switch(_context.prev=_context.next){case 0:dir=path.join(homedir(),".tronbox",evm?"evm-solc":"solc");soljsonPath=path.join(dir,"soljson_v".concat(compilerVersion,".js"));_context.next=1;return fs.ensureDir(path.join(dir));case 1:soljsonUrl="";if(!evm){_context.next=6;break}_context.prev=2;solidityUrl="https://binaries.soliditylang.org/bin";_context.next=3;return req.get("".concat(solidityUrl,"/list.json"));case 3:list=_context.sent;if(list&&list.data){if(list.data.releases&&list.data.releases[compilerVersion]){soljsonUrl="".concat(solidityUrl,"/").concat(list.data.releases[compilerVersion])}else{process.stderr.write(chalk.red(chalk.bold("Error:"),"Unable to locate Solidity compiler version ".concat(chalk.yellow(compilerVersion),"."))+"\n");process.exit(1)}}_context.next=5;break;case 4:_context.prev=4;_t=_context["catch"](2);process.stderr.write(chalk.red(chalk.bold("Error:"),"Failed to fetch Solidity compiler list.")+"\n");process.exit(1);case 5:_context.next=9;break;case 6:_context.prev=6;_solidityUrl="https://tronprotocol.github.io/solc-bin/wasm";_context.next=7;return req.get("".concat(_solidityUrl,"/list.json"));case 7:_list=_context.sent;if(_list&&_list.data&&_list.data.builds){_list.data.builds.forEach(function(_){var version=_.version,path=_.path;if(version===compilerVersion){soljsonUrl="".concat(_solidityUrl,"/").concat(path)}});if(!soljsonUrl){process.stderr.write(chalk.red(chalk.bold("Error:"),"Unable to locate Solidity compiler version ".concat(chalk.yellow(compilerVersion),"."))+"\n");process.exit(1)}}_context.next=9;break;case 8:_context.prev=8;_t2=_context["catch"](6);process.stderr.write(chalk.red(chalk.bold("Error:"),"Failed to fetch Solidity compiler list.")+"\n");process.exit(1);case 9:_context.prev=9;_context.next=10;return req.get(soljsonUrl,{responseType:"arraybuffer"});case 10:res=_context.sent;if(!(res&&res.data)){_context.next=12;break}_context.next=11;return fs.writeFile(soljsonPath,res.data);case 11:if(!fs.existsSync(soljsonPath)){process.stderr.write(chalk.red(chalk.bold("Error:"),"Permission required.")+"\n");process.stderr.write("\nMost likely, you installed Node.js as root.\nPlease, download the compiler manually, running:\n\ntronbox --download-compiler ".concat(compilerVersion," ").concat(evm?"--evm":"","\n"))}else{process.stdout.write("Compiler downloaded.\n")}case 12:_context.next=14;break;case 13:_context.prev=13;_t3=_context["catch"](9);process.stderr.write(chalk.red(chalk.bold("Error:"),"Wrong Solidity compiler version.")+"\n");process.exit(1);case 14:case"end":return _context.stop()}},_callee,null,[[2,4],[6,8],[9,13]])}));return _downloader.apply(this,arguments)}module.exports=downloader;