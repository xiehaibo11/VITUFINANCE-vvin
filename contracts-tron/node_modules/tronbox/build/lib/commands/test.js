"use strict";var version=require("../version");var describe="Run contract tests written in JavaScript";var command={command:"test",describe:describe,builder:function builder(yargs){yargs.usage("TronBox v".concat(version.bundle,"\n\n").concat(describe,"\n\nUsage: $0 test [<files...>] [--file <file>]\n                    [--network <network>] [--compile-all] [--evm]")).version(false).options({file:{describe:"Specify a single test file path to run",type:"string"},network:{describe:"Network name in configuration",type:"string"},"compile-all":{describe:"Recompile all contracts",type:"boolean"},evm:{describe:"Use EVM configuration",type:"boolean"}}).positional("files",{describe:"One or more test file paths to run",type:"string",array:true}).group(["file","network","compile-all","evm","help"],"Options:").example("$0 test","Run all tests").example("$0 test test/t1.js","Run a single test file").example("$0 test test/t1.js test/t2.js","Run multiple test files").example("$0 test --file test/t1.js","Run a single test file")},run:function run(options,done){var OS=require("os");var dir=require("node-dir");var tmp=require("tmp");var Config=require("../../components/Config");var Artifactor=require("../../components/Artifactor");var Test=require("../test");var fs=require("fs");var fsExtra=require("fs-extra");var Environment=require("../environment");var TronWrap=require("../../components/TronWrap");var logErrorAndExit=require("../../components/TronWrap").logErrorAndExit;var config=Config.detect(options);if(!config.network){if(config.networks.development)config.network="development";else if(config.networks.test)config.network="test"}if(!config.network){console.error("\nERROR: Neither development nor test network has been set. Please configure a network in your project configuration.\n");return}try{TronWrap(config.networks[config.network],{evm:options.evm,verify:true,tre:true,logger:options.logger})}catch(err){logErrorAndExit(console,err.message)}process.env.CURRENT="test";var files=[];if(options.file){files=[options.file]}else if(options._.length>0){Array.prototype.push.apply(files,options._)}function getFiles(callback){if(files.length!==0){return callback(null,files)}dir.files(config.test_directory,callback)}getFiles(function(err,files){if(err)return done(err);files=files.filter(function(file){return file.match(config.test_file_extension_regexp)!=null});tmp.dir({unsafeCleanup:true,prefix:"test-"},function(err,temporaryDirectory,removeCallback){if(err)return done(err);function cleanup(){removeCallback();done.apply(void 0,arguments)}function run(){config.logger.log("Using network '"+config.network+"'."+OS.EOL);config.artifactor=new Artifactor(temporaryDirectory);Test.run(config["with"]({test_files:files,contracts_build_directory:temporaryDirectory}),cleanup)}var environmentCallback=function environmentCallback(err){if(err)return done(err);fs.stat(config.contracts_build_directory,function(err){if(err)return run();fsExtra.copy(config.contracts_build_directory,temporaryDirectory,function(err){if(err)return done(err);run()})})};if(config.networks[config.network]){Environment.detect(config,environmentCallback)}else{throw new Error("No development or test environment is configured in your project configuration.")}})})}};module.exports=command;