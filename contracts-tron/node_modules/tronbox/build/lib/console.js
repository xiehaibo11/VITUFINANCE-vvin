"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){(0,_defineProperty2["default"])(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}var ReplManager=require("./repl");var Command=require("./command");var provision=require("../components/Provisioner");var contract=require("../components/Contract");var TronWrap=require("../components/TronWrap");var vm=require("vm");var _require=require("./utils"),expect=_require.expect;var fs=require("fs");var path=require("path");var _require2=require("child_process"),spawn=_require2.spawn;var EventEmitter=require("events");var inherits=require("util").inherits;var chalk=require("chalk");var logErrorAndExit=require("../components/TronWrap").logErrorAndExit;inherits(Console,EventEmitter);function Console(tasks,options){EventEmitter.call(this);var self=this;expect.options(options,["working_directory","contracts_directory","contracts_build_directory","migrations_directory","network","network_id","provider","resolver","build_directory"]);this.options=options;this.repl=options.repl||new ReplManager(options);this.command=new Command(tasks);if(!options.network&&options.networks.development){options.network="development"}try{this.tronWrap=TronWrap()}catch(err){logErrorAndExit(console,err.message)}this.repl.on("exit",function(){self.emit("exit")})}Console.prototype.start=function(callback){var self=this;if(!this.repl){this.repl=new ReplManager(this.options)}this.options.repl=this.repl;this.provision(function(err,abstractions){if(err){self.options.logger.log("Unexpected error: Cannot provision contracts while instantiating the console.");self.options.logger.log(err.stack||err.message||err)}self.repl.start({prompt:"tronbox("+self.options.network+")> ",context:{tronWrap:self.tronWrap,tronWeb:self.tronWrap,ethers:self.tronWrap._ethers?self.tronWrap._ethers:undefined},interpreter:self.interpret.bind(self),done:callback});self.resetContractsInConsoleContext(abstractions)})};Console.prototype.provision=function(callback){var self=this;fs.readdir(this.options.contracts_build_directory,function(err,files){if(err){}var promises=[];files=files||[];files.forEach(function(file){promises.push(new Promise(function(accept,reject){fs.readFile(path.join(self.options.contracts_build_directory,file),"utf8",function(err,body){if(err)return reject(err);try{body=JSON.parse(body)}catch(e){return reject(new Error("Cannot parse "+file+": "+e.message))}accept(body)})}))});Promise.all(promises).then(function(json_blobs){var abstractions=json_blobs.map(function(json){var abstraction=contract(json);provision(abstraction,self.options);return abstraction});self.resetContractsInConsoleContext(abstractions);callback(null,abstractions)})["catch"](callback)})};Console.prototype.resetContractsInConsoleContext=function(abstractions){var self=this;abstractions=abstractions||[];var contextVars={};abstractions.forEach(function(abstraction){if(abstraction.contract_name==="console")return;contextVars[abstraction.contract_name]=abstraction});self.repl.setContextVars(contextVars)};Console.prototype.interpret=function(cmd,context,filename,callback){var self=this;cmd=cmd.trim();if(cmd===""){return callback()}var cmdRes=this.command.getCommand(cmd,this.options.noAliases);if(cmdRes!=null){if(cmdRes.name==="help"){return self.command.run(cmd,this.options,function(err){if(err){console.error(err.message?err.message:err)}callback()})}if(cmdRes.argv.help){this.command.args.parse(cmd);return callback()}var excludeKeys=["_","$0","f","evm","network"];var args=(0,_toConsumableArray2["default"])(cmdRes.argv._);Object.keys(cmdRes.argv).filter(function(key){return!excludeKeys.includes(key)}).forEach(function(key){var value=cmdRes.argv[key];var arg=value;if(Array.isArray(value)){arg=value[value.length-1]}args.push("--".concat(key));if(value!==true)args.push("".concat(arg))});args.push("--network");args.push("".concat(this.options.network));if(this.options.evm)args.push("--evm");var errMsg="";if(cmdRes.argv.evm&&!this.options.evm){errMsg="The command was run with --evm, but the current REPL is not in EVM mode. Please restart the console with --evm if needed."}if(cmdRes.argv.network&&cmdRes.argv.network!==this.options.network){errMsg="The command was run with --network=".concat(cmdRes.argv.network,", but the current REPL is using --network=").concat(this.options.network,". Please restart the console with the correct network if needed.")}if(errMsg){console.error(chalk.red(chalk.bold("ERROR:"),errMsg));return callback()}try{var spawnedProcess=spawn(cmdRes.argv["$0"],args,{env:_objectSpread(_objectSpread({},process.env),{},{FORCE_COLOR:"1"}),encoding:"utf8"});var bufferedError="";spawnedProcess.stderr.on("data",function(data){bufferedError+=data.toString()});spawnedProcess.stdout.on("data",function(data){process.stdout.write(data.toString())});spawnedProcess.on("close",function(code){if(bufferedError){console.error(bufferedError)}if(!code){self.provision(function(err){callback(err)});return}callback()})}catch(error){console.error(chalk.red(chalk.bold("ERROR:"),error&&error.message?error.message:error));callback()}return}var result;try{result=vm.runInContext(cmd,context,{displayErrors:false})}catch(e){return callback(e)}Promise.resolve(result).then(function(res){callback(null,res)})["catch"](callback)};module.exports=Console;