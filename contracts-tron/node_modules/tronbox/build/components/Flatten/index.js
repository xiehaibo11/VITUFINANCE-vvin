"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));function _createForOfIteratorHelper(r,e){var t="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&"number"==typeof r.length){t&&(r=t);var _n=0,F=function F(){};return{s:F,n:function n(){return _n>=r.length?{done:!0}:{done:!1,value:r[_n++]}},e:function e(r){throw r},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function s(){t=t.call(r)},n:function n(){var r=t.next();return a=r.done,r},e:function e(r){u=!0,o=r},f:function f(){try{a||null==t["return"]||t["return"]()}finally{if(u)throw o}}}}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}var fs=require("fs");var path=require("path");var chalk=require("chalk");var tsort=require("tsort");var parser=require("@solidity-parser/parser");var Config=require("../Config");var Resolver=require("../Resolver");var packageJson=require("../../../package.json");var IMPORT_SOLIDITY_REGEX=/^\s*import(\s+)[\s\S]*?;\s*$/gm;function unique(array){return(0,_toConsumableArray2["default"])(new Set(array))}function resolve(_x){return _resolve.apply(this,arguments)}function _resolve(){_resolve=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(importPath){var config,resolver,filePath,fileContents,_t;return _regenerator["default"].wrap(function(_context){while(1)switch(_context.prev=_context.next){case 0:config=Config.detect({});resolver=new Resolver(config);_context.prev=1;if(!(importPath==="tronbox/console.sol")){_context.next=2;break}filePath=path.resolve(__dirname,"../../../console.sol");fileContents=fs.readFileSync(filePath).toString();return _context.abrupt("return",{fileContents:fileContents,filePath:filePath});case 2:_context.next=3;return new Promise(function(resolve,reject){resolver.resolve(importPath,function(err,fileContents,filePath){if(err){reject(err)}else{resolve({fileContents:fileContents,filePath:filePath})}})});case 3:return _context.abrupt("return",_context.sent);case 4:_context.prev=4;_t=_context["catch"](1);throw new Error("File "+importPath+" doesn't exist or is not a readable file.");case 5:case"end":return _context.stop()}},_callee,null,[[1,4]])}));return _resolve.apply(this,arguments)}function getDirPath(filePath){var index1=filePath.lastIndexOf(path.sep);var index2=filePath.lastIndexOf("/");return filePath.substring(0,Math.max(index1,index2))}function getDependencies(filePath,fileContents){try{var ast=parser.parse(fileContents);var imports=[];parser.visit(ast,{ImportDirective:function ImportDirective(node){imports.push(getNormalizedDependencyPath(node.path,filePath))}});return imports}catch(error){throw new Error("Could not parse "+filePath+" for extracting its imports: "+error)}}function getNormalizedDependencyPath(dependency,filePath){if(dependency.startsWith("./")||dependency.startsWith("../")){dependency=path.join(getDirPath(filePath),dependency);dependency=path.normalize(dependency)}return dependency.replace(/\\/g,"/")}function dependenciesDfs(_x2,_x3,_x4){return _dependenciesDfs.apply(this,arguments)}function _dependenciesDfs(){_dependenciesDfs=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(graph,visitedFiles,filePath){var resolved,dependencies,_iterator,_step,dependency,_t2;return _regenerator["default"].wrap(function(_context2){while(1)switch(_context2.prev=_context2.next){case 0:visitedFiles.push(filePath);_context2.next=1;return resolve(filePath);case 1:resolved=_context2.sent;dependencies=getDependencies(resolved.filePath,resolved.fileContents);_iterator=_createForOfIteratorHelper(dependencies);_context2.prev=2;_iterator.s();case 3:if((_step=_iterator.n()).done){_context2.next=5;break}dependency=_step.value;graph.add(dependency,filePath);if(visitedFiles.includes(dependency)){_context2.next=4;break}_context2.next=4;return dependenciesDfs(graph,visitedFiles,dependency);case 4:_context2.next=3;break;case 5:_context2.next=7;break;case 6:_context2.prev=6;_t2=_context2["catch"](2);_iterator.e(_t2);case 7:_context2.prev=7;_iterator.f();return _context2.finish(7);case 8:case"end":return _context2.stop()}},_callee2,null,[[2,6,7,8]])}));return _dependenciesDfs.apply(this,arguments)}function getSortedFilePaths(_x5,_x6){return _getSortedFilePaths.apply(this,arguments)}function _getSortedFilePaths(){_getSortedFilePaths=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee3(entryPoints,projectRoot){var graph,visitedFiles,_iterator2,_step2,entryPoint,topologicalSortedFiles,message,withEntries,files,_t3,_t4;return _regenerator["default"].wrap(function(_context3){while(1)switch(_context3.prev=_context3.next){case 0:graph=tsort();visitedFiles=[];_iterator2=_createForOfIteratorHelper(entryPoints);_context3.prev=1;_iterator2.s();case 2:if((_step2=_iterator2.n()).done){_context3.next=4;break}entryPoint=_step2.value;_context3.next=3;return dependenciesDfs(graph,visitedFiles,entryPoint);case 3:_context3.next=2;break;case 4:_context3.next=6;break;case 5:_context3.prev=5;_t3=_context3["catch"](1);_iterator2.e(_t3);case 6:_context3.prev=6;_iterator2.f();return _context3.finish(6);case 7:_context3.prev=7;topologicalSortedFiles=graph.sort();_context3.next=9;break;case 8:_context3.prev=8;_t4=_context3["catch"](7);if(!_t4.toString().includes("Error: There is a cycle in the graph.")){_context3.next=9;break}message="There is a cycle in the dependency"+" graph, can't compute topological ordering. Files:\n\t"+visitedFiles.join("\n\t");throw new Error(message);case 9:withEntries=topologicalSortedFiles.concat(entryPoints).map(function(f){var fileName=fileNameToGlobalName(f,projectRoot);if(fileName.substring(0,14)==="node_modules\\@"){return fileName.substring(13)}else{return fileName}});files=unique(withEntries);return _context3.abrupt("return",files);case 10:case"end":return _context3.stop()}},_callee3,null,[[1,5,6,7],[7,8]])}));return _getSortedFilePaths.apply(this,arguments)}function fileContentWithoutImports(_x7){return _fileContentWithoutImports.apply(this,arguments)}function _fileContentWithoutImports(){_fileContentWithoutImports=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee4(filePath){var resolved,output;return _regenerator["default"].wrap(function(_context4){while(1)switch(_context4.prev=_context4.next){case 0:_context4.next=1;return resolve(filePath);case 1:resolved=_context4.sent;output=resolved.fileContents.replace(IMPORT_SOLIDITY_REGEX,"");return _context4.abrupt("return",output.trim()+"\n");case 2:case"end":return _context4.stop()}},_callee4)}));return _fileContentWithoutImports.apply(this,arguments)}function fileNameToGlobalName(fileName,projectRoot){var globalName=getFilePathsFromProjectRoot([fileName],projectRoot)[0];if(globalName.indexOf("node_modules/")!==-1){globalName=globalName.substr(globalName.indexOf("node_modules/")+"node_modules/".length)}return globalName}function printContactenation(_x8,_x9){return _printContactenation.apply(this,arguments)}function _printContactenation(){_printContactenation=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee6(files,log){var parts;return _regenerator["default"].wrap(function(_context6){while(1)switch(_context6.prev=_context6.next){case 0:_context6.next=1;return Promise.all(files.map(function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee5(file){var _t5,_t6;return _regenerator["default"].wrap(function(_context5){while(1)switch(_context5.prev=_context5.next){case 0:_t5="// File: "+file+"\n\n";_context5.next=1;return fileContentWithoutImports(file);case 1:_t6=_context5.sent;return _context5.abrupt("return",_t5+_t6);case 2:case"end":return _context5.stop()}},_callee5)}));return function(_x0){return _ref.apply(this,arguments)}}()));case 1:parts=_context6.sent;log(parts.join("\n"));case 2:case"end":return _context6.stop()}},_callee6)}));return _printContactenation.apply(this,arguments)}function getFilePathsFromProjectRoot(filePaths,projectRoot){return filePaths.map(function(f){return path.relative(projectRoot,path.resolve(f))})}var Flatten={run:function run(filePaths,callback){var projectRoot=process.cwd();var filePathsFromProjectRoot=getFilePathsFromProjectRoot(filePaths,projectRoot);var res="// Sources flattened with tronbox v".concat(packageJson.version," ").concat(packageJson.homepage,"\n\n");getSortedFilePaths(filePathsFromProjectRoot,projectRoot).then(function(sortedFiles){printContactenation(sortedFiles,function(str){return res+=str}).then(function(){process.stdout.write(res);callback()})["catch"](function(e){console.error(chalk.red(chalk.bold("ERROR:"),e.message?e.message:e));callback()})})["catch"](function(e){console.error(chalk.red(chalk.bold("ERROR:"),e.message?e.message:e));callback()})}};module.exports=Flatten;