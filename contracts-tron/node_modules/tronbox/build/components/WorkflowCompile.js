"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var mkdirp=require("mkdirp");var path=require("path");var Config=require("./Config");var _compile=require("./Compile");var _require=require("../lib/utils"),expect=_require.expect;var Resolver=require("./Resolver");var Artifactor=require("./Artifactor");var TronWrap=require("./TronWrap");function getCompilerVersion(_x){return _getCompilerVersion.apply(this,arguments)}function _getCompilerVersion(){_getCompilerVersion=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(options){var config,tronWrap,networkInfo,_t;return _regenerator["default"].wrap(function(_context2){while(1)switch(_context2.prev=_context2.next){case 0:config=Config.detect(options);if(!config.network&&config.networks.development){config.network="development"}_context2.prev=1;tronWrap=TronWrap(config.networks[config.network],{evm:options.evm,verify:true,logger:options.logger});_context2.next=2;return tronWrap._getNetworkInfo();case 2:networkInfo=_context2.sent;return _context2.abrupt("return",Promise.resolve(networkInfo||{}));case 3:_context2.prev=3;_t=_context2["catch"](1);return _context2.abrupt("return",Promise.resolve({}));case 4:case"end":return _context2.stop()}},_callee2,null,[[1,3]])}));return _getCompilerVersion.apply(this,arguments)}var Contracts={compile:function compile(options,callback){var self=this;expect.options(options,["contracts_build_directory"]);expect.one(options,["contracts_directory","files"]);var config=Config["default"]().merge(options);if(!config.resolver){config.resolver=new Resolver(config)}if(!config.artifactor){config.artifactor=new Artifactor(config.contracts_build_directory)}function finished(err,contracts,paths){if(err)return callback(err);if(contracts!=null&&Object.keys(contracts).length>0){self.write_contracts(contracts,config,function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(err,abstractions){var _options$networks,_options$networks2,_options$compilers;var solcVersion;return _regenerator["default"].wrap(function(_context){while(1)switch(_context.prev=_context.next){case 0:options.logger.log("");options.logger.log("> Compiled successfully using:");solcVersion=(_options$networks=options.networks)!==null&&_options$networks!==void 0&&_options$networks.compilers?(_options$networks2=options.networks)===null||_options$networks2===void 0||(_options$networks2=_options$networks2.compilers)===null||_options$networks2===void 0||(_options$networks2=_options$networks2.solc)===null||_options$networks2===void 0?void 0:_options$networks2.version:(_options$compilers=options.compilers)===null||_options$compilers===void 0||(_options$compilers=_options$compilers.solc)===null||_options$compilers===void 0?void 0:_options$compilers.version;options.logger.log("  - solc".concat(options.evm?"(EVM)":"",": ").concat(solcVersion));callback(err,abstractions,paths);case 1:case"end":return _context.stop()}},_callee)}));return function(_x2,_x3){return _ref.apply(this,arguments)}}())}else{options.logger.log("> Everything is up to date, there is nothing to compile.");callback(null,[],paths)}}function start(){options.logger.log("Compiling your contracts...");options.logger.log("===========================");if(config.all===true||config.compileAll===true){_compile.all(config,finished)}else{_compile.necessary(config,finished)}}getCompilerVersion(options).then(function(networkInfo){config.networkInfo=networkInfo;start()})["catch"](start)},write_contracts:function write_contracts(contracts,options,callback){mkdirp(options.contracts_build_directory,function(err){if(err!=null){callback(err);return}if(!options.quietWrite){options.logger.log("Writing artifacts to ."+path.sep+path.relative(options.working_directory,options.contracts_build_directory))}var extra_opts={network_id:options.network_id};options.artifactor.saveAll(contracts,extra_opts).then(function(){callback(null,contracts)})["catch"](callback)})}};module.exports=Contracts;