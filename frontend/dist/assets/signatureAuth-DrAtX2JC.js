import{s as e,v as t,u as o,J as r}from"./components-CU5QTYc-.js";import{E as n}from"./element-plus-DyfV_ugy.js";import"./vue-vendor-Th7sVZCl.js";import"./i18n-jHFlwMB3.js";import"./vendor-Bf7WBET-.js";const a="wallet_auth_token",s="wallet_auth_token_exp",c="wallet_auth_wallet",l="0x38";let i=null;function u(e){if(!e)return 0;const t=String(e).trim(),o=Number(t);if(Number.isFinite(o)&&o>0)return o;const r=Date.parse(t);return Number.isFinite(r)?r:0}function g(e){return e?"string"==typeof e?e:String(e?.message||e?.data?.message||e?.error?.message||""):""}function d(e={}){const{walletAddress:t}=e,o=localStorage.getItem(a)||"",r=u(localStorage.getItem(s)),n=(localStorage.getItem(c)||"").toLowerCase();if(console.log("[SignatureAuth] hasValidSignatureAuthCache called with:",{walletAddress:t,hasToken:!!o,expMs:r,expDate:r?new Date(r).toISOString():"N/A",isExpired:r?Date.now()>=r:"N/A",savedWallet:n,currentTime:Date.now(),timeDiff:r?(r-Date.now())/1e3/60/60/24:"N/A"}),!o||!r)return console.log("[SignatureAuth] âŒ No token or expiry, returning false"),!1;if(Date.now()>=r)return console.log("[SignatureAuth] âŒ Token expired, returning false"),!1;if(t){const e=String(t).toLowerCase();if(n&&n!==e)return console.log("[SignatureAuth] âŒ Wallet address mismatch:",{saved:n,current:e}),!1}return console.log("[SignatureAuth] âœ… Valid cache found, returning true"),!0}function h(){console.log("[SignatureAuth] Clearing signature auth cache...");const e=!!localStorage.getItem(a);localStorage.removeItem(a),localStorage.removeItem(s),localStorage.removeItem(c),console.log("[SignatureAuth] âœ… Cache cleared, hadToken:",e)}async function w(d={}){return i||(i=(async()=>{try{const{force:w=!1}=d;if(!e())return{success:!1,skipped:!0,reason:"not_dapp_browser"};const m=t();console.log("[SignatureAuth] Detected wallet type:",m);const f=o();if(!f.isConnected||!f.walletAddress)try{const e=window.ethereum,t=await e.request({method:"eth_accounts"});t&&t.length>0&&f.setWallet(t[0],m)}catch(i){}if(!f.isConnected||!f.walletAddress){const e=await r();if(!e?.success)return{success:!1,error:e?.error||"è¿æ¥é’±åŒ…å¤±è´¥"}}const S=f.walletAddress;if(!S)return{success:!1,error:"æœªè·å–åˆ°é’±åŒ…åœ°å€"};if(console.log("[SignatureAuth] Checking signature auth for wallet:",S),!w&&function(e){if(!e)return!1;const t=(localStorage.getItem(c)||"").toLowerCase(),o=localStorage.getItem(a)||"",r=u(localStorage.getItem(s));return!(!o||!r)&&t===e.toLowerCase()&&Date.now()<r}(S))return console.log("[SignatureAuth] âœ… Already authenticated, using cached token"),{success:!0,alreadyAuthenticated:!0,wallet_address:S};console.log("[SignatureAuth] No valid token, requesting signature...");let p="";try{p=await async function(){const e=window.ethereum;if(!e?.request)throw new Error("æœªæ£€æµ‹åˆ°é’±åŒ…ç¯å¢ƒ");let t="";try{t=await e.request({method:"eth_chainId"})}catch(i){t=""}if(t===l)return t;try{await e.request({method:"wallet_switchEthereumChain",params:[{chainId:l}]})}catch(r){if(4902!==r?.code)throw r;await e.request({method:"wallet_addEthereumChain",params:[{chainId:l,chainName:"BNB Smart Chain",nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},rpcUrls:["https://bsc-dataseed.binance.org/"],blockExplorerUrls:["https://bscscan.com/"]}]})}const o=await e.request({method:"eth_chainId"});if(o!==l)throw new Error("è¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘åå†è¿›è¡Œç­¾åè®¤è¯");return o}(),console.log("[SignatureAuth] Chain verified:",p)}catch(i){return console.error("[SignatureAuth] Chain verification failed:",i),{success:!1,error:g(i)||"ç½‘ç»œæ ¡éªŒå¤±è´¥"}}const A=await async function(e,t){const o={wallet_address:e};t&&(o.chain_id=t);const r=new URLSearchParams(o).toString(),n=await fetch(`/api/auth/challenge?${r}`,{credentials:"include"}),a=await n.json().catch(()=>({}));if(!a?.success)throw new Error(a?.message||"è·å–ç­¾åæŒ‘æˆ˜å¤±è´¥");return a}(S,p),_=A.message;let y;console.log("[SignatureAuth] Challenge received, requesting personal_sign...");try{y=await async function({walletAddress:e,message:t}){const o=window.ethereum;if(!o?.request)throw new Error("æœªæ£€æµ‹åˆ°é’±åŒ…ç¯å¢ƒ");return await o.request({method:"personal_sign",params:[t,e]})}({walletAddress:S,message:_}),console.log("[SignatureAuth] Signature received")}catch(h){return console.error("[SignatureAuth] Signature failed:",h),4001===h?.code?{success:!1,error:"ç”¨æˆ·æ‹’ç»ç­¾å"}:function(e){const t=g(e);return!!t&&(t.includes("å¯†ç ä¸æ­£ç¡®")||t.toLowerCase().includes("wrong password")||t.toLowerCase().includes("password")&&t.toLowerCase().includes("incorrect"))}(h)?{success:!1,error:"é’±åŒ…å¯†ç ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•"}:-32002===h?.code?{success:!1,error:"é’±åŒ…è¯·æ±‚å¤„ç†ä¸­ï¼Œè¯·åœ¨é’±åŒ…å†…å®Œæˆæ“ä½œ"}:{success:!1,error:h?.message||"ç­¾åå¤±è´¥"}}console.log("[SignatureAuth] Verifying signature...");const C=await async function({walletAddress:e,message:t,signature:o}){const r=await fetch("/api/auth/verify",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({wallet_address:e,message:t,signature:o})}),n=await r.json().catch(()=>({}));if(!n?.success)throw new Error(n?.message||"ç­¾åéªŒè¯å¤±è´¥");return n}({walletAddress:S,message:_,signature:y});return function({walletAddress:e,token:t,expiresAt:o}){const r=u(o)||Date.now()+31536e8;localStorage.setItem(a,t),localStorage.setItem(s,String(r)),localStorage.setItem(c,e.toLowerCase())}({walletAddress:S,token:C.token,expiresAt:C.expiresAt}),console.log("[SignatureAuth] âœ… Signature auth successful!"),n.success("ç­¾åè®¤è¯æˆåŠŸ"),{success:!0,wallet_address:S}}catch(h){return console.error("[SignatureAuth] Failed:",h?.message||h),{success:!1,error:h?.message||"ç­¾åè®¤è¯å¤±è´¥"}}})().finally(()=>{i=null}),i)}"undefined"!=typeof window&&(window.__debugSignatureAuth={clearCache:()=>{h(),console.log("%câœ… ç­¾åè®¤è¯ç¼“å­˜å·²æ¸…é™¤ï¼åˆ·æ–°é¡µé¢åé‡è¯•ã€‚","color: green; font-size: 14px; font-weight: bold;")},checkCache:()=>{const e=localStorage.getItem(a),t=localStorage.getItem(s),o=localStorage.getItem(c),r=u(t);console.table({"Has Token":!!e,Token:e?e.substring(0,20)+"...":"N/A",Wallet:o||"N/A","Expires At":r?new Date(r).toISOString():"N/A","Is Expired":r?Date.now()>=r:"N/A","Days Remaining":r?Math.floor((r-Date.now())/1e3/60/60/24):"N/A"});const n=d();console.log("%c"+(n?"âœ… ç¼“å­˜æœ‰æ•ˆ":"âŒ ç¼“å­˜æ— æ•ˆæˆ–å·²è¿‡æœŸ"),"color: "+(n?"green":"red")+"; font-size: 14px; font-weight: bold;")},help:()=>{console.log("%cç­¾åè®¤è¯è°ƒè¯•å·¥å…·","color: blue; font-size: 16px; font-weight: bold;"),console.log("ä½¿ç”¨æ–¹æ³•ï¼š"),console.log("  window.__debugSignatureAuth.checkCache() - æŸ¥çœ‹å½“å‰ç¼“å­˜çŠ¶æ€"),console.log("  window.__debugSignatureAuth.clearCache() - æ¸…é™¤ç¼“å­˜ï¼ˆæ¸…é™¤åéœ€åˆ·æ–°é¡µé¢ï¼‰"),console.log("  window.__debugSignatureAuth.help() - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯")}},console.log("%cğŸ”§ ç­¾åè®¤è¯è°ƒè¯•å·¥å…·å·²åŠ è½½","color: blue; font-size: 14px; font-weight: bold;"),console.log("è¾“å…¥ window.__debugSignatureAuth.help() æŸ¥çœ‹ä½¿ç”¨è¯´æ˜"));export{h as clearSignatureAuthCache,w as ensureTokenPocketSignatureAuth,d as hasValidSignatureAuthCache};
