# å……å€¼å…å¯†æ”¯ä»˜æœºåˆ¶è¯¦è§£

## ä¸€ã€å®Œæ•´çš„è®¤è¯å’Œæ”¯ä»˜æµç¨‹

### 1. é¦–æ¬¡è®¿é—®ç½‘ç«™ - é’±åŒ…ç­¾åè®¤è¯

```
ç”¨æˆ·æ‰“å¼€ TokenPocket â†’ è®¿é—® bocail.com
    â†“
ã€ç¬¬ä¸€æ¬¡å¼¹çª—ã€‘æˆæƒç½‘ç«™è®¿é—®é’±åŒ…åœ°å€
    ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤" â†’ è·å¾—é’±åŒ…åœ°å€
    â†“
ã€ç¬¬äºŒæ¬¡å¼¹çª—ã€‘ç­¾åè®¤è¯è¯·æ±‚
    æ˜¾ç¤ºæ¶ˆæ¯: "Sign this message to authenticate: abc123..."
    è¦æ±‚è¾“å…¥é’±åŒ…å¯†ç  ğŸ”
    â†“
ç”¨æˆ·è¾“å…¥å¯†ç  â†’ é’±åŒ…ç”¨ç§é’¥ç­¾å â†’ è®¤è¯æˆåŠŸ
    â†“
ç½‘ç«™è®°ä½ç”¨æˆ·èº«ä»½ï¼ˆ100å¹´æœ‰æ•ˆæœŸï¼‰
```

**è¿™ä¸€æ­¥çš„ä½œç”¨**ï¼š
- è¯æ˜"æˆ‘æ˜¯è¿™ä¸ªé’±åŒ…åœ°å€çš„ä¸»äºº"
- åªéœ€è¦ç­¾åä¸€æ¬¡ï¼Œé•¿æœŸæœ‰æ•ˆ
- ä¸æ¶‰åŠä»»ä½•èµ„é‡‘æ“ä½œ

---

### 2. å……å€¼æ—¶ - Approveæˆæƒï¼ˆå…å¯†æ”¯ä»˜è®¾ç½®ï¼‰

å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡å……å€¼USDTæ—¶ï¼š

```
ç”¨æˆ·ç‚¹å‡»"å……å€¼USDT"
    â†“
ç½‘ç«™æ£€æŸ¥ï¼šç”¨æˆ·æ˜¯å¦å·²ç»æˆæƒè¿‡å¹³å°æ‰£æ¬¾ï¼Ÿ
    â†“
ã€å¦‚æœæ²¡æœ‰æˆæƒã€‘
    â†“
ã€ç¬¬ä¸‰æ¬¡å¼¹çª—ã€‘Approveæˆæƒè¯·æ±‚
    æ˜¾ç¤º: "æˆæƒ bocail.com ä½¿ç”¨ä½ çš„ USDT"
    æˆæƒé¢åº¦: æ— é™é¢åº¦ (æˆ–æŒ‡å®šé‡‘é¢)
    è¦æ±‚è¾“å…¥é’±åŒ…å¯†ç  ğŸ”
    â†“
ç”¨æˆ·è¾“å…¥å¯†ç  â†’ æˆæƒæˆåŠŸ
    â†“
ã€ä¹‹åçš„å……å€¼ã€‘
    â†“
ç”¨æˆ·è¾“å…¥å……å€¼é‡‘é¢ â†’ ç‚¹å‡»ç¡®è®¤
    â†“
ã€ç¬¬å››æ¬¡å¼¹çª—ã€‘è½¬è´¦ç¡®è®¤
    æ˜¾ç¤º: "è½¬è´¦ 100 USDT åˆ° 0x537B..."
    è¦æ±‚è¾“å…¥é’±åŒ…å¯†ç  ğŸ”
    â†“
ç”¨æˆ·è¾“å…¥å¯†ç  â†’ è½¬è´¦æˆåŠŸ
```

**å…³é”®ç‚¹**ï¼š
- Approveæˆæƒæ˜¯ä¸€æ¬¡æ€§çš„ï¼ˆé™¤éæ’¤é”€ï¼‰
- æˆæƒåï¼Œå¹³å°å¯ä»¥åœ¨ç”¨æˆ·ç¡®è®¤çš„æƒ…å†µä¸‹æ‰£æ¬¾
- æ¯æ¬¡è½¬è´¦ä»éœ€è¦ç”¨æˆ·è¾“å…¥å¯†ç ç¡®è®¤

---

### 3. åç»­å……å€¼ - å…å¯†æ”¯ä»˜ï¼ˆå·²æˆæƒæƒ…å†µï¼‰

å¦‚æœç”¨æˆ·å·²ç»åšè¿‡Approveæˆæƒï¼š

```
ç”¨æˆ·ç‚¹å‡»"å……å€¼USDT"
    â†“
ç½‘ç«™æ£€æŸ¥ï¼šâœ… å·²æˆæƒ
    â†“
ç”¨æˆ·è¾“å…¥å……å€¼é‡‘é¢ â†’ ç‚¹å‡»ç¡®è®¤
    â†“
ã€ç›´æ¥å¼¹çª—ã€‘è½¬è´¦ç¡®è®¤
    æ˜¾ç¤º: "è½¬è´¦ 100 USDT åˆ° 0x537B..."
    è¦æ±‚è¾“å…¥é’±åŒ…å¯†ç  ğŸ”
    â†“
ç”¨æˆ·è¾“å…¥å¯†ç  â†’ è½¬è´¦æˆåŠŸ
```

**"å…å¯†"çš„å«ä¹‰**ï¼š
- å…å»äº†Approveæˆæƒè¿™ä¸€æ­¥
- ä½†è½¬è´¦æ—¶ä»éœ€è¦è¾“å…¥å¯†ç 
- è¿™æ˜¯åŒºå—é“¾çš„å®‰å…¨æœºåˆ¶ï¼Œæ— æ³•ç»•è¿‡

---

## äºŒã€å……å€¼ç›‘æ§æœºåˆ¶ï¼ˆåç«¯è‡ªåŠ¨æ£€æµ‹ï¼‰

### 2.1 ç›‘æ§åŸç†

```javascript
// backend/src/cron/depositMonitorCron.js

å®šæ—¶ä»»åŠ¡ï¼ˆæ¯60ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
    â†“
æ‰«æBSCåŒºå—é“¾æœ€æ–°åŒºå—
    â†“
æŸ¥æ‰¾æ‰€æœ‰è½¬è´¦åˆ°å¹³å°é’±åŒ…çš„USDTäº¤æ˜“
    â†“
æ£€æŸ¥äº¤æ˜“æ˜¯å¦å·²è®°å½•
    â†“
ã€å¦‚æœæ˜¯æ–°äº¤æ˜“ã€‘
    â†“
è®°å½•åˆ°æ•°æ®åº“ deposits è¡¨
    â†“
æ›´æ–°ç”¨æˆ·ä½™é¢
    â†“
å‘é€å……å€¼æˆåŠŸé€šçŸ¥
```

### 2.2 ç›‘æ§é…ç½®

```javascript
// å¹³å°æ”¶æ¬¾åœ°å€
PLATFORM_WALLET = '0x537BD2D898a64b0214FfefD8910E77FA89c6B2bB'

// USDTåˆçº¦åœ°å€ (BSCä¸»ç½‘)
USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955'

// æœ€ä½å……å€¼é‡‘é¢
MIN_DEPOSIT_AMOUNT = 20 USDT

// æ‰«æé—´éš”
SCAN_INTERVAL = 60ç§’
```

### 2.3 å……å€¼æµç¨‹

```
ç”¨æˆ·åœ¨é’±åŒ…è½¬è´¦ 100 USDT åˆ°å¹³å°åœ°å€
    â†“
äº¤æ˜“ä¸Šé“¾ï¼ˆçº¦3ç§’ç¡®è®¤ï¼‰
    â†“
åç«¯å®šæ—¶ä»»åŠ¡æ‰«æåˆ°è¿™ç¬”äº¤æ˜“
    â†“
éªŒè¯ï¼š
    âœ“ è½¬è´¦åˆ°å¹³å°åœ°å€ï¼Ÿ
    âœ“ æ˜¯USDTä»£å¸ï¼Ÿ
    âœ“ é‡‘é¢ >= 20 USDTï¼Ÿ
    âœ“ äº¤æ˜“æœªé‡å¤è®°å½•ï¼Ÿ
    â†“
è®°å½•å……å€¼è®°å½•ï¼š
    - é’±åŒ…åœ°å€
    - å……å€¼é‡‘é¢
    - äº¤æ˜“å“ˆå¸Œ
    - åŒºå—å·
    - æ—¶é—´æˆ³
    â†“
æ›´æ–°ç”¨æˆ·ä½™é¢ï¼š
    user.balance += 100
    â†“
å‰ç«¯æ˜¾ç¤ºå……å€¼æˆåŠŸ
```

---

## ä¸‰ã€Approveæˆæƒæœºåˆ¶è¯¦è§£

### 3.1 ä»€ä¹ˆæ˜¯Approveï¼Ÿ

Approveæ˜¯ERC-20ä»£å¸æ ‡å‡†çš„æˆæƒæœºåˆ¶ï¼š

```solidity
// USDTåˆçº¦çš„approveå‡½æ•°
function approve(address spender, uint256 amount) public returns (bool)
```

**å‚æ•°**ï¼š
- `spender`: è¢«æˆæƒçš„åœ°å€ï¼ˆå¹³å°åˆçº¦åœ°å€ï¼‰
- `amount`: æˆæƒé¢åº¦ï¼ˆå¯ä»¥æ˜¯æ— é™é¢åº¦ï¼‰

**ä½œç”¨**ï¼š
- å…è®¸æŒ‡å®šåœ°å€ä»ä½ çš„é’±åŒ…æ‰£æ¬¾
- ä¸ä¼šç«‹å³è½¬è´¦ï¼Œåªæ˜¯æˆæƒ
- å¯ä»¥éšæ—¶æ’¤é”€

### 3.2 ä¸ºä»€ä¹ˆéœ€è¦Approveï¼Ÿ

**åœºæ™¯1ï¼šæ²¡æœ‰Approveï¼ˆä¼ ç»Ÿè½¬è´¦ï¼‰**
```
ç”¨æˆ·æ¯æ¬¡å……å€¼éƒ½éœ€è¦ï¼š
1. æ‰“å¼€é’±åŒ…
2. è¾“å…¥å¹³å°åœ°å€
3. è¾“å…¥é‡‘é¢
4. è¾“å…¥å¯†ç 
5. ç¡®è®¤è½¬è´¦
```

**åœºæ™¯2ï¼šæœ‰Approveï¼ˆæˆæƒåï¼‰**
```
ç”¨æˆ·é¦–æ¬¡æˆæƒåï¼š
1. åœ¨ç½‘ç«™è¾“å…¥é‡‘é¢
2. ç‚¹å‡»å……å€¼
3. è¾“å…¥å¯†ç ç¡®è®¤
ï¼ˆçœå»äº†æ‰‹åŠ¨è¾“å…¥åœ°å€çš„æ­¥éª¤ï¼‰
```

### 3.3 å®‰å…¨æ€§

**é£é™©**ï¼š
- å¦‚æœæˆæƒç»™æ¶æ„åˆçº¦ï¼Œå¯¹æ–¹å¯ä»¥éšæ—¶æ‰£æ¬¾
- æ— é™é¢åº¦æˆæƒé£é™©æ›´å¤§

**é˜²æŠ¤æªæ–½**ï¼š
1. åªæˆæƒç»™å¯ä¿¡çš„å¹³å°
2. å®šæœŸæ£€æŸ¥æˆæƒåˆ—è¡¨
3. æ’¤é”€ä¸ç”¨çš„æˆæƒ

**åœ¨TokenPocketä¸­æŸ¥çœ‹æˆæƒ**ï¼š
```
TokenPocket â†’ å®‰å…¨ä¸­å¿ƒ â†’ æˆæƒç®¡ç†
å¯ä»¥çœ‹åˆ°æ‰€æœ‰æˆæƒè®°å½•
å¯ä»¥æ’¤é”€ä»»ä½•æˆæƒ
```

---

## å››ã€å®é™…æ“ä½œç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç”¨æˆ·é¦–æ¬¡å……å€¼100 USDT

```
æ­¥éª¤1ï¼šç­¾åè®¤è¯ï¼ˆé¦–æ¬¡è®¿é—®ï¼‰
    TokenPocketå¼¹çª— â†’ è¾“å…¥å¯†ç  â†’ ç­¾åæˆåŠŸ
    
æ­¥éª¤2ï¼šApproveæˆæƒï¼ˆé¦–æ¬¡å……å€¼ï¼‰
    ç½‘ç«™æ£€æµ‹åˆ°æœªæˆæƒ
    TokenPocketå¼¹çª— â†’ "æˆæƒä½¿ç”¨USDT"
    è¾“å…¥å¯†ç  â†’ æˆæƒæˆåŠŸ
    
æ­¥éª¤3ï¼šè½¬è´¦å……å€¼
    è¾“å…¥é‡‘é¢: 100 USDT
    TokenPocketå¼¹çª— â†’ "è½¬è´¦100 USDT"
    è¾“å…¥å¯†ç  â†’ è½¬è´¦æˆåŠŸ
    
æ­¥éª¤4ï¼šåç«¯æ£€æµ‹
    60ç§’å†…æ£€æµ‹åˆ°é“¾ä¸Šäº¤æ˜“
    è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ä½™é¢ +100 USDT
    å‰ç«¯æ˜¾ç¤ºå……å€¼æˆåŠŸ
```

### ç¤ºä¾‹2ï¼šç”¨æˆ·ç¬¬äºŒæ¬¡å……å€¼50 USDT

```
æ­¥éª¤1ï¼šç›´æ¥å……å€¼ï¼ˆå·²æˆæƒï¼‰
    è¾“å…¥é‡‘é¢: 50 USDT
    TokenPocketå¼¹çª— â†’ "è½¬è´¦50 USDT"
    è¾“å…¥å¯†ç  â†’ è½¬è´¦æˆåŠŸ
    
æ­¥éª¤2ï¼šåç«¯æ£€æµ‹
    60ç§’å†…æ£€æµ‹åˆ°é“¾ä¸Šäº¤æ˜“
    è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ä½™é¢ +50 USDT
    å‰ç«¯æ˜¾ç¤ºå……å€¼æˆåŠŸ
```

**å¯¹æ¯”**ï¼š
- ç¬¬ä¸€æ¬¡ï¼šéœ€è¦3æ¬¡è¾“å…¥å¯†ç ï¼ˆç­¾å + æˆæƒ + è½¬è´¦ï¼‰
- ç¬¬äºŒæ¬¡ï¼šåªéœ€1æ¬¡è¾“å…¥å¯†ç ï¼ˆè½¬è´¦ï¼‰

---

## äº”ã€å…³é”®æŠ€æœ¯ç‚¹

### 5.1 å‰ç«¯æ£€æµ‹é’±åŒ…ä½™é¢

```javascript
// frontend/src/components/DepositModal.vue
async function getWalletBalance() {
    const contract = new ethers.Contract(
        USDT_CONTRACT,
        ['function balanceOf(address) view returns (uint256)'],
        provider
    );
    
    const balance = await contract.balanceOf(walletAddress);
    return balance / 1e18;  // è½¬æ¢ä¸ºUSDT
}
```

### 5.2 åç«¯ç›‘æ§é“¾ä¸Šäº¤æ˜“

```javascript
// backend/src/cron/depositMonitorCron.js
async function scanBlocks(fromBlock, toBlock) {
    // æŸ¥è¯¢USDTåˆçº¦çš„Transferäº‹ä»¶
    const logs = await provider.getLogs({
        address: USDT_CONTRACT,
        topics: [
            TRANSFER_TOPIC,  // Transferäº‹ä»¶
            null,            // from (ä»»æ„åœ°å€)
            ethers.utils.hexZeroPad(PLATFORM_WALLET, 32)  // to (å¹³å°åœ°å€)
        ],
        fromBlock,
        toBlock
    });
    
    // å¤„ç†æ¯ç¬”å……å€¼
    for (const log of logs) {
        const amount = parseInt(log.data, 16) / 1e18;
        const from = '0x' + log.topics[1].slice(26);
        const txHash = log.transactionHash;
        
        // è®°å½•åˆ°æ•°æ®åº“
        await recordDeposit(from, amount, txHash);
    }
}
```

### 5.3 æ•°æ®åº“è®°å½•

```sql
-- deposits è¡¨ç»“æ„
CREATE TABLE deposits (
    id INT PRIMARY KEY AUTO_INCREMENT,
    wallet_address VARCHAR(42),
    amount DECIMAL(20,8),
    tx_hash VARCHAR(66) UNIQUE,
    block_number INT,
    status ENUM('pending', 'confirmed'),
    created_at TIMESTAMP
);
```

---

## å…­ã€æ€»ç»“

### ç”¨æˆ·ä½“éªŒæµç¨‹

| æ“ä½œ | éœ€è¦å¯†ç  | é¢‘ç‡ | è¯´æ˜ |
|------|---------|------|------|
| ç­¾åè®¤è¯ | âœ… éœ€è¦ | é¦–æ¬¡è®¿é—® | è¯æ˜é’±åŒ…æ‰€æœ‰æƒ |
| Approveæˆæƒ | âœ… éœ€è¦ | é¦–æ¬¡å……å€¼ | æˆæƒå¹³å°æ‰£æ¬¾ |
| å……å€¼è½¬è´¦ | âœ… éœ€è¦ | æ¯æ¬¡å……å€¼ | å®é™…è½¬è´¦æ“ä½œ |
| ä½™é¢æŸ¥è¯¢ | âŒ ä¸éœ€è¦ | éšæ—¶ | åªè¯»æ“ä½œ |

### "å…å¯†æ”¯ä»˜"çš„çœŸå®å«ä¹‰

1. **å…å»Approveæˆæƒæ­¥éª¤**ï¼ˆé¦–æ¬¡æˆæƒåï¼‰
2. **å¯ä»¥å®ç°çœŸæ­£å…å¯†**ï¼ˆéœ€è¦é€‚é…é’±åŒ…çš„å…å¯†åŠŸèƒ½ï¼‰
3. **ç®€åŒ–æ“ä½œæµç¨‹**ï¼ˆä¸ç”¨æ‰‹åŠ¨è¾“å…¥åœ°å€ï¼‰
4. **æé«˜ç”¨æˆ·ä½“éªŒ**ï¼ˆå‡å°‘æ“ä½œæ­¥éª¤ï¼‰

### âš ï¸ å½“å‰é—®é¢˜ï¼šæœªé€‚é…é’±åŒ…å…å¯†åŠŸèƒ½

**TokenPocketç­‰é’±åŒ…çš„å…å¯†æ”¯ä»˜åŠŸèƒ½**ï¼š
- ç”¨æˆ·å¯ä»¥åœ¨é’±åŒ…è®¾ç½®ä¸­å¼€å¯"å°é¢å…å¯†æ”¯ä»˜"
- ä¾‹å¦‚ï¼š100 USDTä»¥ä¸‹çš„è½¬è´¦æ— éœ€è¾“å…¥å¯†ç 
- è¿™æ˜¯é’±åŒ…æœ¬èº«çš„åŠŸèƒ½ï¼Œä¸æ˜¯ç½‘ç«™æ§åˆ¶çš„

**å½“å‰ç½‘ç«™çš„é—®é¢˜**ï¼š
- ä½¿ç”¨ `eth_sendTransaction` æ–¹æ³•å‘èµ·è½¬è´¦
- æ¯æ¬¡éƒ½ä¼šå¼¹å‡ºé’±åŒ…ç¡®è®¤çª—å£
- å³ä½¿ç”¨æˆ·å¼€å¯äº†å…å¯†æ”¯ä»˜ï¼Œä»ç„¶éœ€è¦ç¡®è®¤
- æ²¡æœ‰åˆ©ç”¨é’±åŒ…çš„å…å¯†æ”¯ä»˜åŠŸèƒ½

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
éœ€è¦é€‚é…é’±åŒ…çš„å…å¯†æ”¯ä»˜APIï¼Œè®©å°é¢å……å€¼å¯ä»¥çœŸæ­£å…å¯†

### å®‰å…¨æœºåˆ¶

1. **ç§é’¥æ°¸ä¸ç¦»å¼€é’±åŒ…**
2. **æ¯æ¬¡è½¬è´¦éƒ½éœ€è¦å¯†ç ç¡®è®¤**
3. **å¯ä»¥éšæ—¶æ’¤é”€æˆæƒ**
4. **åç«¯è‡ªåŠ¨æ£€æµ‹é“¾ä¸Šäº¤æ˜“**
5. **é˜²æ­¢é‡å¤å……å€¼è®°å½•**

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2026-02-27
**é€‚ç”¨ç‰ˆæœ¬**: VituFinance v1.0


---

## ä¸ƒã€å¦‚ä½•å®ç°çœŸæ­£çš„å…å¯†æ”¯ä»˜

### 7.1 å½“å‰å®ç°ï¼ˆéœ€è¦æ¯æ¬¡ç¡®è®¤ï¼‰

```javascript
// frontend/src/components/DepositModal.vue (ç¬¬334è¡Œ)
const transactionHash = await ethereum.request({
  method: 'eth_sendTransaction',  // âŒ æ¯æ¬¡éƒ½å¼¹çª—ç¡®è®¤
  params: [{
    from: walletStore.walletAddress,
    to: USDT_CONTRACT_ADDRESS.value,
    data: data,
    gas: '0x186A0'
  }]
})
```

**é—®é¢˜**ï¼š
- `eth_sendTransaction` æ˜¯æ ‡å‡†çš„ä»¥å¤ªåŠRPCæ–¹æ³•
- æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè§¦å‘é’±åŒ…ç¡®è®¤å¼¹çª—
- å³ä½¿ç”¨æˆ·åœ¨é’±åŒ…ä¸­è®¾ç½®äº†"å°é¢å…å¯†"ï¼Œä»ç„¶éœ€è¦ç¡®è®¤
- ç”¨æˆ·ä½“éªŒä¸å¥½ï¼Œå……å€¼æµç¨‹ç¹ç

### 7.2 TokenPocketçš„å…å¯†æ”¯ä»˜åŠŸèƒ½

**TokenPocketé’±åŒ…è®¾ç½®**ï¼š
```
TokenPocket â†’ æˆ‘çš„ â†’ è®¾ç½® â†’ å…å¯†æ”¯ä»˜
- å¼€å¯å…å¯†æ”¯ä»˜
- è®¾ç½®å…å¯†é¢åº¦ï¼š100 USDT
- è®¾ç½®å…å¯†æ—¶é•¿ï¼š24å°æ—¶
```

**å…å¯†æ”¯ä»˜çš„å·¥ä½œåŸç†**ï¼š
1. ç”¨æˆ·åœ¨é’±åŒ…ä¸­å¼€å¯å…å¯†æ”¯ä»˜
2. è®¾ç½®å…å¯†é¢åº¦ï¼ˆå¦‚100 USDTä»¥ä¸‹ï¼‰
3. åœ¨å…å¯†æ—¶é•¿å†…ï¼Œå°é¢è½¬è´¦æ— éœ€è¾“å…¥å¯†ç 
4. è¶…è¿‡é¢åº¦æˆ–æ—¶é•¿ï¼Œéœ€è¦é‡æ–°è¾“å…¥å¯†ç 

### 7.3 æ”¹è¿›æ–¹æ¡ˆ1ï¼šä½¿ç”¨TokenPocketä¸“å±API

TokenPocketæä¾›äº†ä¸“å±çš„å…å¯†æ”¯ä»˜APIï¼š

```javascript
// æ£€æµ‹æ˜¯å¦æ˜¯TokenPocket
const isTokenPocket = window.tokenpocket !== undefined

if (isTokenPocket) {
  // ä½¿ç”¨TokenPocketçš„å…å¯†æ”¯ä»˜API
  const result = await window.tokenpocket.send({
    method: 'transfer',
    params: {
      from: walletStore.walletAddress,
      to: USDT_CONTRACT_ADDRESS.value,
      value: '0x0',  // USDTè½¬è´¦ï¼ŒETHé‡‘é¢ä¸º0
      data: data,
      gas: '0x186A0',
      // å…³é”®å‚æ•°ï¼šå¯ç”¨å…å¯†æ”¯ä»˜
      skipConfirmation: true,  // è·³è¿‡ç¡®è®¤å¼¹çª—
      usePasswordlessPayment: true  // ä½¿ç”¨å…å¯†æ”¯ä»˜
    }
  })
} else {
  // å…¶ä»–é’±åŒ…ä½¿ç”¨æ ‡å‡†æ–¹æ³•
  const transactionHash = await ethereum.request({
    method: 'eth_sendTransaction',
    params: [...]
  })
}
```

**ä¼˜ç‚¹**ï¼š
- å……åˆ†åˆ©ç”¨TokenPocketçš„å…å¯†åŠŸèƒ½
- å°é¢å……å€¼æ— éœ€ç¡®è®¤ï¼Œä½“éªŒæµç•…
- å¤§é¢å……å€¼ä»éœ€ç¡®è®¤ï¼Œä¿è¯å®‰å…¨

**ç¼ºç‚¹**ï¼š
- åªé€‚ç”¨äºTokenPocket
- å…¶ä»–é’±åŒ…ï¼ˆMetaMaskç­‰ï¼‰ä¸æ”¯æŒ

### 7.4 æ”¹è¿›æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç­¾åæˆæƒ + åç«¯ä»£ä»˜

**æµç¨‹**ï¼š
```
1. ç”¨æˆ·é¦–æ¬¡å……å€¼æ—¶ç­¾åæˆæƒï¼ˆä¸€æ¬¡æ€§ï¼‰
   â†“
2. åç»­å……å€¼æ—¶ï¼š
   - ç”¨æˆ·åœ¨ç½‘ç«™è¾“å…¥é‡‘é¢
   - å‰ç«¯ç”Ÿæˆç­¾åè¯·æ±‚
   - ç”¨æˆ·ç­¾åï¼ˆæ— éœ€å¯†ç ï¼Œæˆ–ä½¿ç”¨å…å¯†ç­¾åï¼‰
   â†“
3. åç«¯éªŒè¯ç­¾ååï¼š
   - ä½¿ç”¨å¹³å°é’±åŒ…ä»£ä»˜gasè´¹
   - è°ƒç”¨USDTåˆçº¦çš„transferFrom
   - ä»ç”¨æˆ·é’±åŒ…æ‰£æ¬¾åˆ°å¹³å°åœ°å€
   â†“
4. ç”¨æˆ·æ— éœ€æ”¯ä»˜gasè´¹ï¼Œæ— éœ€ç¡®è®¤è½¬è´¦
```

**å®ç°ä»£ç **ï¼š

```javascript
// å‰ç«¯ï¼šç”Ÿæˆå……å€¼ç­¾å
async function generateDepositSignature(amount) {
  const message = {
    action: 'deposit',
    amount: amount,
    timestamp: Date.now(),
    nonce: generateNonce()
  }
  
  // ä½¿ç”¨ personal_signï¼ˆå…å¯†ç­¾åï¼‰
  const signature = await ethereum.request({
    method: 'personal_sign',
    params: [JSON.stringify(message), walletStore.walletAddress]
  })
  
  return { message, signature }
}

// åç«¯ï¼šéªŒè¯ç­¾åå¹¶ä»£ä»˜
async function processDepositWithSignature(req, res) {
  const { message, signature, walletAddress } = req.body
  
  // 1. éªŒè¯ç­¾å
  const recoveredAddress = ethers.utils.verifyMessage(
    JSON.stringify(message), 
    signature
  )
  
  if (recoveredAddress.toLowerCase() !== walletAddress.toLowerCase()) {
    return res.status(401).json({ success: false, message: 'ç­¾åæ— æ•ˆ' })
  }
  
  // 2. æ£€æŸ¥ç”¨æˆ·æˆæƒé¢åº¦
  const allowance = await usdtContract.allowance(
    walletAddress, 
    platformWalletAddress
  )
  
  if (allowance < message.amount) {
    return res.status(400).json({ 
      success: false, 
      message: 'æˆæƒé¢åº¦ä¸è¶³ï¼Œè¯·å…ˆæˆæƒ' 
    })
  }
  
  // 3. ä½¿ç”¨å¹³å°é’±åŒ…è°ƒç”¨transferFrom
  const tx = await usdtContract.transferFrom(
    walletAddress,           // from
    platformWalletAddress,   // to
    ethers.utils.parseUnits(message.amount.toString(), 18)  // amount
  )
  
  await tx.wait()
  
  // 4. è®°å½•å……å€¼
  await recordDeposit(walletAddress, message.amount, tx.hash)
  
  res.json({ success: true, txHash: tx.hash })
}
```

**ä¼˜ç‚¹**ï¼š
- çœŸæ­£çš„å…å¯†æ”¯ä»˜ï¼ˆåªéœ€ç­¾åï¼Œæ— éœ€ç¡®è®¤è½¬è´¦ï¼‰
- ç”¨æˆ·æ— éœ€æ”¯ä»˜gasè´¹
- å…¼å®¹æ‰€æœ‰é’±åŒ…
- å®‰å…¨æ€§é«˜ï¼ˆéœ€è¦Approveæˆæƒï¼‰

**ç¼ºç‚¹**ï¼š
- éœ€è¦åç«¯æŒæœ‰å¹³å°é’±åŒ…ç§é’¥
- å¹³å°éœ€è¦æ”¯ä»˜gasè´¹
- å®ç°å¤æ‚åº¦è¾ƒé«˜

### 7.5 æ”¹è¿›æ–¹æ¡ˆ3ï¼šä½¿ç”¨Gaslessäº¤æ˜“ï¼ˆæ¨èï¼‰

**EIP-2771 å…ƒäº¤æ˜“ï¼ˆMeta Transactionï¼‰**ï¼š

```javascript
// å‰ç«¯ï¼šç”Ÿæˆå…ƒäº¤æ˜“ç­¾å
async function createMetaTransaction(amount) {
  const nonce = await relayerContract.getNonce(walletAddress)
  
  const metaTx = {
    from: walletAddress,
    to: USDT_CONTRACT_ADDRESS,
    value: 0,
    gas: 100000,
    nonce: nonce,
    data: transferData,  // USDT transfer data
    chainId: 56  // BSC
  }
  
  // ç­¾åå…ƒäº¤æ˜“ï¼ˆå…å¯†ï¼‰
  const signature = await ethereum.request({
    method: 'eth_signTypedData_v4',
    params: [walletAddress, JSON.stringify(metaTx)]
  })
  
  // æäº¤åˆ°ä¸­ç»§æœåŠ¡å™¨
  const response = await fetch('/api/relay/submit', {
    method: 'POST',
    body: JSON.stringify({ metaTx, signature })
  })
  
  return response.json()
}

// åç«¯ï¼šä¸­ç»§æœåŠ¡å™¨ä»£ä»˜gas
async function relayMetaTransaction(req, res) {
  const { metaTx, signature } = req.body
  
  // 1. éªŒè¯ç­¾å
  const isValid = verifyMetaTxSignature(metaTx, signature)
  if (!isValid) {
    return res.status(401).json({ success: false })
  }
  
  // 2. ä½¿ç”¨ä¸­ç»§é’±åŒ…å‘é€äº¤æ˜“ï¼ˆæ”¯ä»˜gasï¼‰
  const tx = await relayerWallet.sendTransaction({
    to: forwarderContract.address,
    data: forwarderContract.interface.encodeFunctionData('execute', [
      metaTx,
      signature
    ])
  })
  
  await tx.wait()
  
  res.json({ success: true, txHash: tx.hash })
}
```

**ä¼˜ç‚¹**ï¼š
- ç”¨æˆ·å®Œå…¨å…å¯†ï¼ˆåªéœ€ç­¾åï¼Œæ— éœ€ç¡®è®¤ï¼‰
- ç”¨æˆ·æ— éœ€æ”¯ä»˜gasè´¹
- ç¬¦åˆEIP-2771æ ‡å‡†
- å®‰å…¨æ€§é«˜

**ç¼ºç‚¹**ï¼š
- éœ€è¦éƒ¨ç½²Forwarderåˆçº¦
- éœ€è¦è¿è¡Œä¸­ç»§æœåŠ¡å™¨
- å®ç°å¤æ‚åº¦æœ€é«˜

### 7.6 æ¨èå®ç°æ–¹æ¡ˆ

**çŸ­æœŸæ–¹æ¡ˆï¼ˆå¿«é€Ÿå®ç°ï¼‰**ï¼š
ä½¿ç”¨æ–¹æ¡ˆ1 - TokenPocketä¸“å±API
- å¼€å‘æˆæœ¬ä½
- ç«‹å³æ”¹å–„TokenPocketç”¨æˆ·ä½“éªŒ
- å…¶ä»–é’±åŒ…ä¿æŒç°æœ‰æµç¨‹

**é•¿æœŸæ–¹æ¡ˆï¼ˆæœ€ä½³ä½“éªŒï¼‰**ï¼š
ä½¿ç”¨æ–¹æ¡ˆ3 - Gaslesså…ƒäº¤æ˜“
- æ‰€æœ‰é’±åŒ…éƒ½æ”¯æŒ
- ç”¨æˆ·ä½“éªŒæœ€ä½³
- ç¬¦åˆè¡Œä¸šæ ‡å‡†

### 7.7 å®ç°ç¤ºä¾‹ä»£ç 

```javascript
// frontend/src/components/DepositModal.vue
// æ”¹è¿›åçš„å……å€¼å‡½æ•°

const handleDeposit = async () => {
  // ... å‰ç½®æ£€æŸ¥ ...
  
  try {
    const amount = parseFloat(depositAmount.value)
    const ethereum = window.ethereum
    
    // æ£€æµ‹é’±åŒ…ç±»å‹
    const isTokenPocket = window.tokenpocket !== undefined
    const isMetaMask = ethereum.isMetaMask
    
    // æ„é€ USDTè½¬è´¦æ•°æ®
    const data = buildTransferData(platformWalletAddress.value, amount)
    
    let transactionHash
    
    if (isTokenPocket) {
      // âœ… TokenPocketï¼šä½¿ç”¨å…å¯†æ”¯ä»˜API
      console.log('[Deposit] Using TokenPocket passwordless payment')
      
      try {
        const result = await window.tokenpocket.send({
          method: 'transfer',
          params: {
            from: walletStore.walletAddress,
            to: USDT_CONTRACT_ADDRESS.value,
            value: '0x0',
            data: data,
            gas: '0x186A0',
            skipConfirmation: true,  // è·³è¿‡ç¡®è®¤ï¼ˆå¦‚æœç”¨æˆ·å¼€å¯äº†å…å¯†ï¼‰
            usePasswordlessPayment: true
          }
        })
        transactionHash = result.hash || result
      } catch (tpError) {
        // å¦‚æœå…å¯†å¤±è´¥ï¼Œé™çº§åˆ°æ ‡å‡†æ–¹æ³•
        console.log('[Deposit] Passwordless failed, fallback to standard')
        transactionHash = await ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: walletStore.walletAddress,
            to: USDT_CONTRACT_ADDRESS.value,
            data: data,
            gas: '0x186A0'
          }]
        })
      }
    } else {
      // âŒ å…¶ä»–é’±åŒ…ï¼šä½¿ç”¨æ ‡å‡†æ–¹æ³•ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
      console.log('[Deposit] Using standard eth_sendTransaction')
      transactionHash = await ethereum.request({
        method: 'eth_sendTransaction',
        params: [{
          from: walletStore.walletAddress,
          to: USDT_CONTRACT_ADDRESS.value,
          data: data,
          gas: '0x186A0'
        }]
      })
    }
    
    console.log('[Deposit] Transaction sent:', transactionHash)
    
    // æäº¤åˆ°åç«¯
    await submitDepositRecord(transactionHash)
    
    alert(t('depositModal.depositSuccess'))
    closeModal()
    
  } catch (error) {
    console.error('[Deposit] Error:', error)
    alert(error.message)
  } finally {
    isProcessing.value = false
  }
}

// æ„é€ USDTè½¬è´¦æ•°æ®
function buildTransferData(toAddress, amount) {
  const decimals = currentChainConfig.value.decimals
  const amountWei = BigInt(Math.floor(amount * Math.pow(10, decimals)))
    .toString(16)
    .padStart(64, '0')
  const to = toAddress.slice(2).padStart(64, '0')
  return '0xa9059cbb' + to + amountWei
}
```

---

## å…«ã€æ€»ç»“ä¸å»ºè®®

### å½“å‰çŠ¶æ€
- âœ… ç­¾åè®¤è¯å·²å®ç°
- âœ… Approveæˆæƒå·²å®ç°
- âœ… å……å€¼ç›‘æ§å·²å®ç°
- âŒ æœªé€‚é…é’±åŒ…å…å¯†æ”¯ä»˜åŠŸèƒ½

### ç”¨æˆ·ä½“éªŒé—®é¢˜
- æ¯æ¬¡å……å€¼éƒ½éœ€è¦åœ¨é’±åŒ…ä¸­ç¡®è®¤
- å³ä½¿ç”¨æˆ·å¼€å¯äº†å…å¯†æ”¯ä»˜ï¼Œä»éœ€ç¡®è®¤
- å……å€¼æµç¨‹ç¹çï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

### æ”¹è¿›å»ºè®®

**ä¼˜å…ˆçº§1ï¼ˆç«‹å³å®æ–½ï¼‰**ï¼š
- é€‚é…TokenPocketçš„å…å¯†æ”¯ä»˜API
- æ£€æµ‹é’±åŒ…ç±»å‹ï¼Œä½¿ç”¨å¯¹åº”çš„æœ€ä½³æ–¹æ³•
- é¢„è®¡å¼€å‘æ—¶é—´ï¼š2-4å°æ—¶

**ä¼˜å…ˆçº§2ï¼ˆä¸­æœŸè§„åˆ’ï¼‰**ï¼š
- å®ç°ç­¾åæˆæƒ + åç«¯ä»£ä»˜æ–¹æ¡ˆ
- æ”¯æŒæ‰€æœ‰é’±åŒ…çš„å…å¯†ä½“éªŒ
- é¢„è®¡å¼€å‘æ—¶é—´ï¼š1-2å¤©

**ä¼˜å…ˆçº§3ï¼ˆé•¿æœŸè§„åˆ’ï¼‰**ï¼š
- å®ç°Gaslesså…ƒäº¤æ˜“
- æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒ
- é¢„è®¡å¼€å‘æ—¶é—´ï¼š3-5å¤©

### æŠ€æœ¯è¦ç‚¹
1. æ£€æµ‹é’±åŒ…ç±»å‹ï¼ˆTokenPocketã€MetaMaskç­‰ï¼‰
2. ä½¿ç”¨é’±åŒ…ä¸“å±APIï¼ˆå¦‚æœæ”¯æŒï¼‰
3. é™çº§åˆ°æ ‡å‡†æ–¹æ³•ï¼ˆå¦‚æœä¸æ”¯æŒï¼‰
4. æä¾›æ¸…æ™°çš„ç”¨æˆ·æç¤º
5. è®°å½•è¯¦ç»†çš„æ—¥å¿—ä¾¿äºè°ƒè¯•

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2026-02-27
**æ›´æ–°å†…å®¹**: æ·»åŠ å…å¯†æ”¯ä»˜å®ç°æ–¹æ¡ˆ
