# 扣费功能使用指南

## 功能状态

✅ **扣费功能已完成开发并部署上线**

---

## 快速开始

### 1. 检查用户授权状态

使用脚本快速检查用户是否已授权：

```bash
cd backend
node scripts/check_user_allowance.js <用户地址> <链>
```

**示例**：
```bash
# BSC 链
node scripts/check_user_allowance.js 0x1234567890abcdef1234567890abcdef12345678 BSC

# ETH 链
node scripts/check_user_allowance.js 0x1234567890abcdef1234567890abcdef12345678 ETH

# TRON 链
node scripts/check_user_allowance.js TXxx...xxx TRON
```

**输出示例**：
```
============================================================
检查用户授权额度
============================================================

[BSC] 检查授权状态...
用户地址: 0x1234567890abcdef1234567890abcdef12345678
平台地址: 0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4

💰 用户 USDT 余额: 500.0000 USDT
✅ 授权额度: 0.0 USDT

⚠️  用户尚未授权平台地址

📝 授权方法：
1. 访问区块链浏览器
   https://bscscan.com/token/0x55d398326f99059fF775485246999027B3197955#writeContract
2. 连接钱包
3. 找到 approve 方法
4. 填写参数：
   - spender: 0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4
   - amount: 1000000000000000000000 (1000 USDT)
5. 确认交易

⛽ 平台 BNB 余额: 0.0000
⚠️  平台 Gas 费不足，建议充值
============================================================
```

---

### 2. 用户授权平台地址

用户需要先授权平台地址才能进行扣费。详细教程请参考：

📖 **[用户授权平台地址教程.md](./用户授权平台地址教程.md)**

**快速授权方法**：

#### BSC 链
1. 访问：https://bscscan.com/token/0x55d398326f99059fF775485246999027B3197955#writeContract
2. 连接钱包
3. 执行 `approve` 方法：
   - `spender`: `0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4`
   - `amount`: `1000000000000000000000`（1000 USDT）

#### ETH 链
1. 访问：https://etherscan.io/token/0xdac17f958d2ee523a2206206994597c13d831ec7#writeContract
2. 连接钱包
3. 执行 `approve` 方法：
   - `spender`: `0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d`
   - `amount`: `1000000000`（1000 USDT）

#### TRON 链
1. 访问：https://tronscan.org/#/contract/TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t/code
2. 点击 "Write Contract"
3. 连接 TronLink 钱包
4. 执行 `approve` 方法：
   - `spender`: `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi`
   - `amount`: `1000000000`（1000 USDT）

---

### 3. 执行扣费操作

授权完成后，在管理后台执行扣费：

1. 访问：https://bocail.com/admin
2. 登录管理后台
3. 进入"用户管理"页面
4. 找到目标用户
5. 点击"扣费"按钮
6. 填写扣费信息：
   - **扣费金额**：输入 USDT 数量（0.01-10000）
   - **扣费链**：选择 BSC、ETH 或 TRON
   - **操作员备注**：可选，内部备注
7. 点击"确认扣费"
8. 二次确认
9. 等待交易完成
10. 查看交易哈希

---

## 平台地址

| 链 | 平台地址 | USDT 合约 |
|----|---------|----------|
| BSC | `0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4` | `0x55d398326f99059fF775485246999027B3197955` |
| ETH | `0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d` | `0xdAC17F958D2ee523a2206206994597C13D831ec7` |
| TRON | `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi` | `TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t` |

---

## 常见错误及解决方法

### 错误 1: "用户授权额度不足"

**错误信息**：
```
用户授权额度不足。当前授权：0.0 USDT，需要：1 USDT
```

**原因**：用户尚未授权平台地址，或授权额度已用完。

**解决方法**：
1. 使用脚本检查授权状态：
   ```bash
   node scripts/check_user_allowance.js <用户地址> <链>
   ```
2. 让用户授权平台地址（参考上面的授权方法）
3. 授权完成后重试扣费

---

### 错误 2: "用户钱包余额不足"

**错误信息**：
```
用户钱包余额不足。当前余额：0.5 USDT
```

**原因**：用户钱包中的 USDT 余额不足以支付扣费金额。

**解决方法**：
1. 检查用户钱包余额
2. 让用户充值 USDT
3. 或者降低扣费金额

---

### 错误 3: "平台钱包 Gas 费不足"

**错误信息**：
```
平台钱包 Gas 费不足
```

**原因**：平台钱包中的原生代币（BNB/ETH/TRX）不足以支付 Gas 费。

**解决方法**：
1. 给平台钱包充值 Gas 费：
   - **BSC**: 充值 0.1-0.5 BNB 到 `0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4`
   - **ETH**: 充值 0.01-0.05 ETH 到 `0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d`
   - **TRON**: 充值 50-100 TRX 到 `TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi`
2. 充值完成后重试扣费

---

### 错误 4: "缺少必要参数"

**错误信息**：
```
缺少必要参数
```

**原因**：前端发送的请求参数不完整。

**解决方法**：
1. 清除浏览器缓存
2. 按 `Ctrl + Shift + R`（Windows/Linux）或 `Cmd + Shift + R`（Mac）强制刷新页面
3. 重新登录管理后台
4. 重试扣费操作

---

## 查看扣费记录

### 方法 1: 数据库查询

```sql
-- 查看最近的扣费记录
SELECT * FROM wallet_deduction_logs 
ORDER BY created_at DESC 
LIMIT 10;

-- 查看某个用户的扣费记录
SELECT * FROM wallet_deduction_logs
WHERE wallet_address = '0x...'
ORDER BY created_at DESC;

-- 统计扣费总额（按链）
SELECT chain, COUNT(*) as count, SUM(amount) as total
FROM wallet_deduction_logs
GROUP BY chain;
```

### 方法 2: 区块链浏览器

根据交易哈希在区块链浏览器查看：

- **BSC**: https://bscscan.com/tx/[交易哈希]
- **ETH**: https://etherscan.io/tx/[交易哈希]
- **TRON**: https://tronscan.org/#/transaction/[交易哈希]

---

## 监控和维护

### 1. 检查平台钱包余额

定期检查平台钱包的 Gas 费余额：

```bash
# 使用脚本检查（会显示平台余额）
node scripts/check_user_allowance.js <任意用户地址> BSC
```

或直接在区块链浏览器查看：

- **BSC**: https://bscscan.com/address/0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4
- **ETH**: https://etherscan.io/address/0x8a92c73FdE5d0313303989eB269d6d17ffb1ba9d
- **TRON**: https://tronscan.org/#/address/TGMVmVmHDV2UDEHusKWnrhUt6dfGXCpYSi

### 2. 查看后端日志

```bash
# 查看实时日志
pm2 logs vitu-backend

# 查看最近 50 行日志
pm2 logs vitu-backend --lines 50 --nostream
```

### 3. 检查服务状态

```bash
# 查看 PM2 状态
pm2 status

# 重启服务（如需要）
pm2 restart vitu-backend
```

---

## API 接口

### 扣费接口

```
POST /api/admin/users/deduct-from-wallet
```

**请求参数**：
```json
{
  "wallet_address": "0x...",
  "amount": 100,
  "chain": "BSC",
  "admin_remark": "可选备注"
}
```

**返回示例**：
```json
{
  "success": true,
  "message": "扣费成功",
  "data": {
    "txHash": "0x...",
    "blockNumber": 12345678,
    "amount": 100,
    "chain": "BSC",
    "from": "0x...",
    "to": "0x..."
  }
}
```

### 查询授权接口

```
GET /api/admin/users/check-allowance?wallet_address=0x...&chain=BSC
```

**返回示例**：
```json
{
  "success": true,
  "data": {
    "allowance": "1000.0000",
    "balance": "500.0000",
    "platform_address": "0x0290df8A512Eff68d0B0a3ECe1E3F6aAB49d79D4",
    "chain": "BSC"
  }
}
```

---

## 测试流程

### 完整测试步骤

1. **准备测试钱包**
   - 创建测试钱包
   - 充值少量 USDT（如 10 USDT）
   - 充值 Gas 费（BNB/ETH/TRX）

2. **检查授权状态**
   ```bash
   node scripts/check_user_allowance.js <测试钱包地址> BSC
   ```

3. **执行授权**
   - 按照教程授权平台地址
   - 授权额度：10-100 USDT

4. **验证授权**
   ```bash
   node scripts/check_user_allowance.js <测试钱包地址> BSC
   ```
   确认授权额度正确

5. **测试扣费**
   - 在管理后台执行小额扣费（如 1 USDT）
   - 等待交易确认
   - 查看交易哈希

6. **验证结果**
   - 在区块链浏览器查看交易
   - 检查数据库日志记录
   - 确认用户余额变化

---

## 相关文档

- 📖 [用户授权平台地址教程.md](./用户授权平台地址教程.md) - 详细授权教程
- 📖 [钱包扣费功能说明.md](./钱包扣费功能说明.md) - 功能完整说明
- 📖 [TRON扣费功能完成.md](./TRON扣费功能完成.md) - TRON 开发文档
- 📖 [imToken使用教程.md](./imToken使用教程.md) - imToken 授权教程
- 📖 [钱包扣费功能部署完成.md](./钱包扣费功能部署完成.md) - 部署报告

---

## 技术支持

如有问题，请：

1. 查看后端日志：`pm2 logs vitu-backend`
2. 使用检查脚本：`node scripts/check_user_allowance.js`
3. 查看区块链浏览器确认交易状态
4. 检查数据库日志记录

---

**重要提示**：
- 扣费操作不可撤销，请谨慎操作
- 确保用户已授权平台地址
- 确保平台钱包有足够的 Gas 费
- 定期检查和维护平台钱包余额
