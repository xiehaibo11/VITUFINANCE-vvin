# DepositRelay 合约部署说明

## 一、合约功能

这是一个充值中继合约，实现免密支付功能：

1. 用户首次授权USDT给合约地址
2. 后续充值时，用户只需签名（不需要密码）
3. 后端验证签名后调用合约
4. 合约从用户钱包转USDT到平台地址

## 二、部署步骤

### 方式1：使用Remix IDE（推荐，最简单）

#### 步骤1：打开Remix
访问：https://remix.ethereum.org/

#### 步骤2：创建合约文件
1. 在左侧文件浏览器，创建新文件 `DepositRelay.sol`
2. 复制 `DepositRelay.sol` 的全部代码粘贴进去

#### 步骤3：编译合约
1. 点击左侧 "Solidity Compiler" 图标
2. 选择编译器版本：`0.8.0` 或更高
3. 点击 "Compile DepositRelay.sol"
4. 确保没有错误

#### 步骤4：连接钱包
1. 点击左侧 "Deploy & Run Transactions" 图标
2. Environment 选择：`Injected Provider - MetaMask` 或 `Injected Provider - TokenPocket`
3. 确保钱包连接到 BSC 主网（Chain ID: 56）
4. 确保钱包有足够的BNB支付gas费（约0.01 BNB）

#### 步骤5：部署合约
1. 在 "Deploy" 部分，找到 `PLATFORMWALLET` 输入框
2. 输入你的平台收款地址：`0x537BD2D898a64b0214FfefD8910E77FA89c6B2bB`
3. 点击 "Deploy" 按钮
4. 在钱包中确认交易
5. 等待交易确认（约3秒）

#### 步骤6：获取合约地址
1. 部署成功后，在下方 "Deployed Contracts" 看到合约
2. 复制合约地址（例如：`0x1234...5678`）
3. 保存这个地址，后续需要用到

#### 步骤7：验证合约（可选但推荐）
1. 访问 BscScan：https://bscscan.com/
2. 搜索你的合约地址
3. 点击 "Contract" → "Verify and Publish"
4. 选择编译器版本和优化设置
5. 粘贴合约代码
6. 提交验证

### 方式2：使用Hardhat（适合开发者）

#### 步骤1：安装依赖
```bash
cd vitufinance/contracts
npm init -y
npm install --save-dev hardhat @nomiclabs/hardhat-ethers ethers
```

#### 步骤2：初始化Hardhat
```bash
npx hardhat
# 选择 "Create a JavaScript project"
```

#### 步骤3：配置Hardhat
创建 `hardhat.config.js`：

```javascript
require("@nomiclabs/hardhat-ethers");

module.exports = {
  solidity: "0.8.0",
  networks: {
    bsc: {
      url: "https://bsc-dataseed.binance.org/",
      chainId: 56,
      accounts: [process.env.DEPLOYER_PRIVATE_KEY]
    },
    bscTestnet: {
      url: "https://data-seed-prebsc-1-s1.binance.org:8545/",
      chainId: 97,
      accounts: [process.env.DEPLOYER_PRIVATE_KEY]
    }
  }
};
```

#### 步骤4：创建部署脚本
创建 `scripts/deploy.js`：

```javascript
const hre = require("hardhat");

async function main() {
  const platformWallet = "0x537BD2D898a64b0214FfefD8910E77FA89c6B2bB";
  
  console.log("Deploying DepositRelay contract...");
  console.log("Platform wallet:", platformWallet);
  
  const DepositRelay = await hre.ethers.getContractFactory("DepositRelay");
  const depositRelay = await DepositRelay.deploy(platformWallet);
  
  await depositRelay.deployed();
  
  console.log("✅ DepositRelay deployed to:", depositRelay.address);
  console.log("Transaction hash:", depositRelay.deployTransaction.hash);
  
  // 等待几个区块确认
  console.log("Waiting for confirmations...");
  await depositRelay.deployTransaction.wait(5);
  
  console.log("✅ Deployment confirmed!");
  console.log("\nNext steps:");
  console.log("1. Save contract address:", depositRelay.address);
  console.log("2. Verify contract on BscScan");
  console.log("3. Update backend .env file");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

#### 步骤5：部署
```bash
# 设置部署者私钥
export DEPLOYER_PRIVATE_KEY=你的私钥

# 部署到BSC主网
npx hardhat run scripts/deploy.js --network bsc

# 或部署到测试网（推荐先测试）
npx hardhat run scripts/deploy.js --network bscTestnet
```

## 三、部署后配置

### 1. 更新后端环境变量

编辑 `backend/.env`：

```bash
# 充值中继合约地址（部署后获得）
DEPOSIT_RELAY_CONTRACT=0x你的合约地址

# 平台钱包私钥（用于调用合约）
PLATFORM_PRIVATE_KEY=0x你的私钥

# 平台收款地址
PLATFORM_WALLET_ADDRESS=0x537BD2D898a64b0214FfefD8910E77FA89c6B2bB
```

### 2. 测试合约

在Remix或Hardhat中测试：

```javascript
// 1. 检查合约配置
await depositRelay.platformWallet()
// 应该返回: 0x537BD2D898a64b0214FfefD8910E77FA89c6B2bB

await depositRelay.minDepositAmount()
// 应该返回: 20000000000000000000 (20 USDT)

await depositRelay.maxDepositAmount()
// 应该返回: 10000000000000000000000 (10000 USDT)

// 2. 检查用户授权（需要用户先授权）
await depositRelay.checkAllowance("0x用户地址")

// 3. 检查用户余额
await depositRelay.checkBalance("0x用户地址")
```

## 四、前端集成

### 用户授权USDT给合约

```javascript
// frontend/src/utils/depositHelper.js

const DEPOSIT_RELAY_CONTRACT = '0x你的合约地址'

export async function approveDepositRelay(walletAddress) {
  const provider = new ethers.providers.Web3Provider(window.ethereum)
  const signer = provider.getSigner()
  
  const usdtContract = new ethers.Contract(
    '0x55d398326f99059fF775485246999027B3197955',
    ['function approve(address spender, uint256 amount) returns (bool)'],
    signer
  )
  
  // 授权无限额度给合约
  const tx = await usdtContract.approve(
    DEPOSIT_RELAY_CONTRACT,
    ethers.constants.MaxUint256
  )
  
  await tx.wait()
  console.log('✅ Approved deposit relay contract')
}
```

### 生成签名

```javascript
export async function generateDepositSignature(walletAddress, amount, nonce) {
  const provider = new ethers.providers.Web3Provider(window.ethereum)
  const signer = provider.getSigner()
  
  // 构造消息哈希（与合约的getMessageHash一致）
  const messageHash = ethers.utils.solidityKeccak256(
    ['address', 'uint256', 'bytes32'],
    [walletAddress, ethers.utils.parseUnits(amount.toString(), 18), nonce]
  )
  
  // 签名
  const signature = await signer.signMessage(ethers.utils.arrayify(messageHash))
  
  return signature
}
```

## 五、后端集成

### 调用合约执行充值

```javascript
// backend/src/services/depositService.js

const { ethers } = require('ethers')

const provider = new ethers.providers.JsonRpcProvider(
  'https://bsc-dataseed.binance.org/'
)

const platformWallet = new ethers.Wallet(
  process.env.PLATFORM_PRIVATE_KEY,
  provider
)

const depositRelayContract = new ethers.Contract(
  process.env.DEPOSIT_RELAY_CONTRACT,
  [
    'function depositWithSignature(address user, uint256 amount, bytes32 nonce, bytes signature) external',
    'function checkAllowance(address user) external view returns (uint256)',
    'function isNonceUsed(bytes32 nonce) external view returns (bool)'
  ],
  platformWallet
)

async function executeDeposit(userAddress, amount, nonce, signature) {
  // 1. 检查nonce是否已使用
  const isUsed = await depositRelayContract.isNonceUsed(nonce)
  if (isUsed) {
    throw new Error('Nonce already used')
  }
  
  // 2. 检查授权
  const allowance = await depositRelayContract.checkAllowance(userAddress)
  const amountWei = ethers.utils.parseUnits(amount.toString(), 18)
  
  if (allowance.lt(amountWei)) {
    throw new Error('Insufficient allowance')
  }
  
  // 3. 调用合约
  const tx = await depositRelayContract.depositWithSignature(
    userAddress,
    amountWei,
    nonce,
    signature,
    {
      gasLimit: 150000,
      gasPrice: ethers.utils.parseUnits('3', 'gwei')
    }
  )
  
  console.log('Transaction sent:', tx.hash)
  
  // 4. 等待确认
  const receipt = await tx.wait(1)
  
  if (receipt.status !== 1) {
    throw new Error('Transaction failed')
  }
  
  return {
    txHash: tx.hash,
    blockNumber: receipt.blockNumber
  }
}

module.exports = { executeDeposit }
```

## 六、成本估算

### Gas费用
- 部署合约：约 1,500,000 gas ≈ 0.0045 BNB ≈ $2.7
- 每次充值：约 100,000 gas ≈ 0.0003 BNB ≈ $0.18

### 优化建议
1. 设置最低充值金额（20 USDT）
2. 收取0.5%手续费覆盖gas成本
3. 批量处理充值请求

## 七、安全检查清单

- [ ] 合约已部署到正确的网络（BSC主网）
- [ ] 平台钱包地址配置正确
- [ ] 合约owner是安全的地址
- [ ] 私钥安全存储（不要提交到Git）
- [ ] 合约已在BscScan验证
- [ ] 充值限额设置合理
- [ ] 测试网测试通过
- [ ] 监控合约事件日志

## 八、常见问题

### Q1: 部署失败，提示gas不足
A: 确保钱包有至少0.01 BNB

### Q2: 用户充值失败，提示"Insufficient allowance"
A: 用户需要先授权USDT给合约地址

### Q3: 如何更新平台收款地址？
A: 调用合约的 `updatePlatformWallet(newAddress)` 函数（仅owner可调用）

### Q4: 如何暂停充值？
A: 调用合约的 `pause()` 函数（仅owner可调用）

### Q5: 合约可以升级吗？
A: 当前合约不可升级。如需升级，需要部署新合约并迁移用户授权。

## 九、监控和维护

### 监控合约事件
```javascript
depositRelayContract.on('Deposit', (user, amount, nonce, timestamp) => {
  console.log('New deposit:', {
    user,
    amount: ethers.utils.formatUnits(amount, 18),
    nonce,
    timestamp: new Date(timestamp * 1000)
  })
})
```

### 定期检查
- 平台钱包BNB余额（用于支付gas）
- 合约是否被暂停
- 异常交易监控

---

**部署完成后，记得保存合约地址并更新到后端配置！**
